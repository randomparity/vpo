# MP4 Conversion Policy for Video Policy Orchestrator
# This policy converts MKV files to MP4 for device compatibility.
#
# Usage: vpo process --policy mp4-conversion-policy.yaml [--dry-run] <file.mkv>
#
# Note: MP4 has codec limitations. This policy will skip files with:
# - TrueHD or DTS-HD MA audio
# - PGS or VobSub subtitles
# - Embedded fonts/attachments

schema_version: 13

config:
  audio_languages: [eng, und]
  subtitle_languages: [eng]
  on_error: continue

phases:
  - name: strip
    # Remove attachments (not supported in MP4)
    filter_attachments:
      remove_all: true

  - name: convert
    # Container conversion to MP4
    container:
      target: mp4
      # Skip files with incompatible codecs instead of failing
      on_incompatible_codec: skip

  - name: organize
    # Track type ordering
    track_order:
      - video
      - audio_main
      - audio_alternate
      - subtitle_main
      - subtitle_forced
      - audio_commentary
      - subtitle_commentary
      - attachment

    # Default flag behavior
    default_flags:
      set_first_video_default: true
      set_preferred_audio_default: true
      set_preferred_subtitle_default: false
      clear_other_defaults: true
