# Conditional HEVC Transcoding Policy (V6)
#
# This policy demonstrates the V6 transcode configuration with:
# - Conditional skip: Skip files already in HEVC at 1080p or lower
# - Quality settings: CRF mode with preset and tune options
# - Hardware acceleration: Auto-detect with CPU fallback
# - Audio preservation: Preserve lossless codecs
#
# Usage:
#   vpo transcode --policy transcode-conditional-hevc.yaml /path/to/videos/
#   vpo jobs start
#
# See docs/usage/transcode-policy.md for full documentation.

schema_version: 6

transcode:
  video:
    # Target codec: hevc (H.265) provides excellent compression
    target_codec: hevc

    # Skip transcoding if ALL these conditions are met:
    # - Already HEVC codec
    # - Resolution is 1080p or smaller
    # - Bitrate is under 15 Mbps
    skip_if:
      codec_matches:
        - hevc
        - h265
      resolution_within: 1080p
      bitrate_under: 15M

    # Quality settings (CRF mode)
    quality:
      mode: crf
      crf: 20                # 18-23 for high quality
      preset: medium         # slower = better compression
      tune: film             # Options: film, animation, grain

    # Resolution scaling
    scaling:
      max_resolution: 1080p  # Scale down 4K to 1080p
      algorithm: lanczos     # Best quality scaling algorithm
      upscale: false         # Don't upscale smaller content

    # Hardware acceleration
    hardware_acceleration:
      enabled: auto          # auto, nvenc, qsv, vaapi, none
      fallback_to_cpu: true  # Fall back to CPU if HW unavailable

  audio:
    # Codecs to preserve (stream-copy without re-encoding)
    preserve_codecs:
      - truehd      # Dolby TrueHD (lossless)
      - dts-hd      # DTS-HD Master Audio (lossless)
      - flac        # FLAC (lossless)
      - pcm_s24le   # PCM 24-bit

    # Target codec for non-preserved audio
    transcode_to: aac

    # Bitrate for transcoded audio
    transcode_bitrate: 192k
