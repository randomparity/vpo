# Multi-Phase Production Policy (V12)
# Enterprise workflow with all operations across 7 phases
schema_version: 12

config:
  audio_language_preference: [eng, jpn, und]
  subtitle_language_preference: [eng, jpn]
  commentary_patterns: [commentary, director, "audio description"]
  on_error: continue

phases:
  - name: prepare
    container:
      target: mkv
      on_incompatible_codec: transcode

  - name: compress
    transcode:
      video:
        target_codec: hevc
        skip_if:
          codec_matches: [hevc, h265]
          resolution_within: 1080p
        quality:
          mode: crf
          crf: 20
          preset: medium
        scaling:
          max_resolution: 1080p
          algorithm: lanczos
        hardware_acceleration:
          enabled: auto
          fallback_to_cpu: true
        # Custom FFmpeg arguments for complex files with many streams
        ffmpeg_args:
          - "-max_muxing_queue_size"
          - "9999"
      audio:
        preserve_codecs: [truehd, dts-hd, flac, aac]
        transcode_to: aac
        transcode_bitrate: 128k

  - name: metadata
    # Set video track language from Radarr/Sonarr original language metadata
    conditional:
      - name: tag-original-language
        when:
          plugin_metadata:
            plugin: radarr
            field: original_language
            operator: exists
        then:
          - set_language:
              track_type: video
              from_plugin_metadata:
                plugin: radarr
                field: original_language
        else:
          # Fall back to Sonarr if Radarr metadata unavailable
          - set_language:
              track_type: video
              from_plugin_metadata:
                plugin: sonarr
                field: original_language
      # Enable forced subs when Radarr reports a non-English original language
      - name: force-subs-for-foreign-language
        when:
          plugin_metadata:
            plugin: radarr
            field: original_language
            operator: neq
            value: eng
        then:
          - set_forced:
              track_type: subtitle
              language: eng
              value: true

  - name: cleanup
    audio_filter:
      languages: [eng, jpn, und]
      minimum: 1
      fallback:
        mode: content_language
    subtitle_filter:
      languages: [eng, jpn]
      preserve_forced: true
    attachment_filter:
      remove_all: false

  - name: organize
    track_order:
      - video
      - audio_main
      - audio_alternate
      - audio_commentary
      - subtitle_main
      - subtitle_forced
      - subtitle_commentary
      - attachment
    default_flags:
      set_first_video_default: true
      set_preferred_audio_default: true
      set_preferred_subtitle_default: false
      clear_other_defaults: true
    conditional:
      - name: force-subs-for-foreign
        when:
          not:
            exists:
              track_type: audio
              language: eng
        then:
          - set_forced:
              track_type: subtitle
              language: eng
              value: true

  # Clean container metadata and set title from Radarr/Sonarr
  - name: container-tags
    conditional:
      # Clear stale encoder and comment tags
      - name: clear-encoder
        when:
          container_metadata:
            field: encoder
            operator: exists
        then:
          - set_container_metadata:
              field: encoder
              value: ""
      - name: clear-comment
        when:
          container_metadata:
            field: comment
            operator: exists
        then:
          - set_container_metadata:
              field: comment
              value: ""
      # Clear any existing title before setting a fresh one
      - name: clear-title
        when:
          container_metadata:
            field: title
            operator: exists
        then:
          - set_container_metadata:
              field: title
              value: ""
      # Set container title from Radarr, fall back to Sonarr
      - name: set-title-from-radarr
        when:
          plugin_metadata:
            plugin: radarr
            field: external_title
            operator: exists
        then:
          - set_container_metadata:
              field: title
              from_plugin_metadata:
                plugin: radarr
                field: external_title
      - name: set-title-from-sonarr
        when:
          and:
            - not:
                plugin_metadata:
                  plugin: radarr
                  field: external_title
                  operator: exists
            - plugin_metadata:
                plugin: sonarr
                field: external_title
                operator: exists
        then:
          - set_container_metadata:
              field: title
              from_plugin_metadata:
                plugin: sonarr
                field: external_title

  - name: enhance
    audio_synthesis:
      tracks:
        - name: "AAC Stereo"
          codec: aac
          channels: stereo
          bitrate: "192k"
          skip_if_exists:
            codec: aac
            channels: 2
          source:
            prefer:
              - codec: [truehd, dts-hd, flac]
              - codec: [dts, ac3]
    transcription:
      enabled: true
      detect_commentary: true
      reorder_commentary: true
    # Set file modification time to release/air date from Radarr or Sonarr;
    # falls back to preserving original mtime if no date is available
    file_timestamp:
      mode: release_date
      date_source: auto
      fallback: preserve
