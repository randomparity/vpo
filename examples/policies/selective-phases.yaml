# Selective Phases Policy (V13)
# Designed for CLI phase selection
#
# Contains three independent phases that can be run individually or combined.
# Use --phases on the CLI to pick which one(s) to execute:
#
#   vpo policy run -p selective-phases.yaml --phases quick-fix video.mkv
#   vpo policy run -p selective-phases.yaml --phases full-normalize video.mkv
#   vpo policy run -p selective-phases.yaml --phases archive video.mkv
#   vpo policy run -p selective-phases.yaml --phases quick-fix,archive video.mkv
#
# This pattern lets you keep a single policy file with multiple "modes"
# instead of maintaining separate files for each workflow.
schema_version: 13
name: Selective Phase Toolkit
description: Three independent phases for CLI selection — quick metadata fix, full normalization, or archive-quality transcoding.

config:
  audio_languages: [eng, und]
  subtitle_languages: [eng]
  on_error: skip

phases:
  # Phase: quick-fix
  # Lightweight metadata-only pass — no filtering, no transcoding, no remuxing.
  # Just sets default flags so the right tracks auto-play in media players.
  #
  # Usage: vpo policy run -p selective-phases.yaml --phases quick-fix video.mkv
  - name: quick-fix
    default_flags:
      set_first_video_default: true
      set_preferred_audio_default: true
      clear_other_defaults: true  # Remove stale default flags from other tracks

  # Phase: full-normalize
  # Removes unwanted language tracks, reorders remaining tracks, and sets defaults.
  # Does not transcode — only metadata and track structure changes.
  #
  # Usage: vpo policy run -p selective-phases.yaml --phases full-normalize video.mkv
  - name: full-normalize
    keep_audio:
      languages: [eng, und]
      minimum: 1
    keep_subtitles:
      languages: [eng]
      preserve_forced: true
    filter_attachments:
      remove_all: true  # Strip fonts and cover art
    track_order:
      - video
      - audio_main
      - audio_alternate
      - subtitle_main
      - subtitle_forced
    default_flags:
      set_first_video_default: true
      set_preferred_audio_default: true
      clear_other_defaults: true

  # Phase: archive
  # High-quality HEVC transcode for long-term storage. Uses slow preset and
  # lower CRF (18) for near-lossless quality at the cost of encoding time.
  # Preserves all lossless audio codecs.
  #
  # Usage: vpo policy run -p selective-phases.yaml --phases archive video.mkv
  - name: archive
    transcode:
      video:
        to: hevc
        skip_if:
          codec_matches: [hevc, h265]  # Don't re-encode already-HEVC files
        crf: 18        # Near-lossless quality (lower = better, 18 is very high)
        preset: slow   # Slower encoding = better compression efficiency
        max_resolution: 1080p
        scale_algorithm: lanczos
        hw: auto
        hw_fallback: true
      audio:
        preserve: [truehd, dts-hd, flac]  # Keep all lossless audio
        to: aac
        bitrate: 256k  # Higher bitrate for archival quality
