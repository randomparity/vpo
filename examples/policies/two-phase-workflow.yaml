# Two Phase Workflow Policy (V12)
# Demonstrates the cleanup-then-organize pattern
#
# A common two-phase approach: first strip unwanted tracks, then sort
# the remaining tracks and set default flags. This pattern keeps phases
# focused on a single responsibility.
#
# Usage:
#   vpo policy run -p two-phase-workflow.yaml /path/to/videos/ --dry-run
schema_version: 12
name: Cleanup & Organize
description: Two-phase pattern â€” filter unwanted tracks, then sort and set defaults.

config:
  # Language preferences are used by default_flags to pick which track
  # gets the "default" flag. First match wins (eng preferred over jpn).
  audio_language_preference: [eng, jpn, und]
  subtitle_language_preference: [eng, jpn]
  on_error: skip

phases:
  # Phase 1: Remove tracks not matching preferred languages.
  - name: cleanup
    audio_filter:
      languages: [eng, jpn, und]
      minimum: 1  # Always keep at least 1 audio track

      # Fallback determines what happens when NO tracks match the language list.
      fallback:
        # Available modes:
        #   content_language - keep tracks matching the file's detected content language
        #   keep_all         - disable filtering, keep everything
        #   keep_first       - keep the first N tracks to meet minimum
        #   error            - fail with InsufficientTracksError
        mode: keep_first

    subtitle_filter:
      languages: [eng, jpn]
      preserve_forced: true  # Keep forced subs regardless of language

    attachment_filter:
      # Remove all attachments (fonts, cover art, etc.).
      # Warning: removing fonts may break styled ASS/SSA subtitles.
      remove_all: true

  # Phase 2: Sort tracks into a consistent order and set default flags.
  - name: finalize
    # Track order defines the desired sequence of tracks in the output file.
    # Available slot types:
    #   video             - all video tracks
    #   audio_main        - primary (non-commentary, non-alternate) audio
    #   audio_alternate   - alternate audio tracks
    #   audio_commentary  - commentary audio tracks (matched by commentary_patterns)
    #   subtitle_main     - primary subtitle tracks
    #   subtitle_forced   - forced subtitle tracks
    #   subtitle_commentary - commentary subtitle tracks
    #   attachment        - fonts, cover art, etc.
    track_order:
      - video
      - audio_main
      - audio_alternate
      - subtitle_main
      - subtitle_forced

    # Default flags control which tracks auto-play in media players.
    default_flags:
      set_first_video_default: true       # First video track gets default flag
      set_preferred_audio_default: true    # Best-matching audio (by language pref) gets default
      clear_other_defaults: true           # Remove default flag from all other tracks
