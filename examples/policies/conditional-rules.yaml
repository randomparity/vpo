# Conditional Rules Policy (V12)
# Advanced conditional logic with boolean operators
#
# Conditional rules evaluate conditions against the file's tracks and metadata,
# then execute actions when conditions are met. Rules are evaluated in order
# within a phase. Each rule has a "when" condition and a "then" action list,
# with an optional "else" for the false case.
#
# Available condition types:
#   exists              - true if a matching track exists
#   not                 - negates a condition
#   and / or            - boolean combinators (take a list of sub-conditions)
#   count               - compare track count (eq, gte, lte, gt, lt)
#   audio_is_multi_language - true if audio tracks span multiple languages
#   plugin_metadata     - check plugin-provided metadata fields
#   container_metadata  - check container-level tags (title, encoder, etc.)
#
# Available actions:
#   set_forced / set_default   - set track flags (by track_type + language)
#   set_language               - change track language tag
#   set_container_metadata     - set container-level metadata tags
#   skip_video_transcode       - skip video transcoding for this file
#   warn                       - log a warning message
#
# Usage:
#   vpo policy run -p conditional-rules.yaml /path/to/videos/ --dry-run
schema_version: 12
name: Smart Conditional Rules
description: Force subtitles for foreign audio, skip transcode for compliant files, and set track defaults automatically.

config:
  audio_language_preference: [eng, jpn, und]
  subtitle_language_preference: [eng, jpn]

  # "continue" keeps processing remaining phases even if one rule errors.
  # Useful for conditional policies where partial success is acceptable.
  on_error: continue

phases:
  - name: apply-rules
    conditional:
      # Rule 1: Force English subs when audio contains multiple languages.
      # The threshold (0.05 = 5%) prevents tiny segments from triggering detection.
      - name: force-subs-for-multi-language
        when:
          audio_is_multi_language:
            threshold: 0.05  # Min fraction of total duration for a language to count
        then:
          - set_forced:
              track_type: subtitle
              language: eng
              value: true
          - set_default:
              track_type: subtitle
              language: eng
              value: true

      # Rule 2: Force English subs when there's no English audio track.
      # Uses "not > exists" to check for absence of a track type+language combo.
      - name: force-subs-when-no-english-audio
        when:
          not:
            exists:
              track_type: audio
              language: eng
        then:
          - set_forced:
              track_type: subtitle
              language: eng
              value: true

      # Rule 3: Skip video transcoding if file is already HEVC with audio.
      # Uses "and" to combine multiple conditions (all must be true).
      - name: skip-transcode-for-compliant-files
        when:
          and:
            - exists:
                track_type: video
                codec: [hevc, h265]
            - count:
                track_type: audio
                gte: 1  # Ensure at least one audio track exists
        then:
          - skip_video_transcode: true

      # Rule 4: Warn when a file has no subtitle tracks at all.
      - name: warn-for-missing-subtitles
        when:
          not:
            exists:
              track_type: subtitle
        then:
          - warn: "No subtitle tracks found"

      # Rule 5: Auto-set default flag when there's exactly one audio track.
      # The "count" condition supports: eq, gte, lte, gt, lt operators.
      - name: set-audio-default-if-single-track
        when:
          count:
            track_type: audio
            eq: 1
        then:
          - set_default:
              track_type: audio
              value: true
