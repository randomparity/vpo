# Media Normalization Policy (V12)
# Production-ready policy for standardizing media files
#
# A 7-phase pipeline that demonstrates conditional phase execution:
#   - skip_when:  skip phases based on file characteristics (OR logic — any match skips)
#   - on_error:   per-phase error handling override (skip, continue, fail)
#   - run_if:     run phase only if a previous phase modified the file
#   - depends_on: skip phase if named dependencies didn't complete
#
# Usage:
#   vpo policy run -p media-normalization.yaml /path/to/videos/ --dry-run
schema_version: 12
name: Full Media Normalization
description: >-
  Production pipeline: container prep, transcription analysis, track filtering,
  ordering, audio synthesis, HEVC transcoding, and post-transcode verification.

config:
  audio_language_preference: [eng, und]
  subtitle_language_preference: [eng, und]
  commentary_patterns: [commentary, director, "audio description", cast]

  # Global on_error applies to phases that don't override it.
  on_error: skip

phases:
  # Phase 1: Migrate all container types to MKV.
  # skip_when conditions use OR logic — if ANY condition matches, the phase is skipped.
  # Available skip_when conditions:
  #   container: [mkv]           - skip if container format matches
  #   video_codec: [hevc, h265]  - skip if video codec matches
  #   file_size_under: 500MB     - skip if file is under threshold
  #   resolution_under: 1080p    - skip if resolution is below
  #   duration_under: 30m        - skip if duration is under
  #   audio_codec_exists: truehd - skip if audio codec is present
  - name: prepare
    skip_when:
      container: [mkv]  # Already MKV — no conversion needed
    container:
      target: mkv
      on_incompatible_codec: transcode

  # Phase 2: Analyze audio tracks to detect actual language content
  # and purpose (main audio vs. commentary audio).
  # Skip for short clips (under 5 minutes) — not worth the analysis time.
  - name: analyze
    skip_when:
      duration_under: 5m
    # Per-phase on_error overrides the global setting.
    # "continue" here means: if transcription fails, log it and move on
    # to the next phase rather than skipping the rest of the file.
    on_error: continue
    transcription:
      enabled: true
      update_language_from_transcription: true
      confidence_threshold: 0.8
      detect_commentary: true

  # Phase 3: Clear stale track metadata, remove unwanted language tracks.
  - name: cleanup
    # audio_actions / subtitle_actions run BEFORE filters in the same phase.
    # This lets you clear flags before filtering decisions are made.
    audio_actions:
      clear_all_forced: true    # Remove forced flag from all audio tracks
      clear_all_default: true   # Remove default flag from all audio tracks
      clear_all_titles: false   # Keep existing track titles
    audio_filter:
      languages: [eng, und]
      minimum: 1
      fallback:
        mode: content_language
    subtitle_actions:
      clear_all_forced: true
      clear_all_default: true
      clear_all_titles: false
    subtitle_filter:
      languages: [eng, und]
      preserve_forced: false  # Don't preserve forced subs (we cleared forced above)
    attachment_filter:
      remove_all: true  # Strip fonts and cover art

  # Phase 4: Organize track ordering, set track defaults, apply metadata rules.
  - name: organize
    track_order:
      - video
      - audio_main
      - audio_alternate
      - audio_commentary
      - subtitle_main
      - subtitle_forced
      - subtitle_commentary
    default_flags:
      set_first_video_default: true
      set_preferred_audio_default: true
      set_preferred_subtitle_default: false
      # Auto-force and auto-default subtitles when the default audio track's
      # language doesn't match the audio_language_preference list.
      # Useful for foreign-language content in mixed libraries.
      set_subtitle_forced_when_audio_differs: true
      set_subtitle_default_when_audio_differs: true
    conditional:
      # Set video track language from Radarr's metadata (movie original language).
      - name: sync_video_language_from_radarr
        when:
          plugin_metadata:
            plugin: radarr
            field: original_language
            operator: exists
        then:
          - set_language:
              track_type: video
              from_plugin_metadata:
                plugin: radarr
                field: original_language

      # Fall back to Sonarr for TV content.
      - name: sync_video_language_from_sonarr
        when:
          plugin_metadata:
            plugin: sonarr
            field: original_language
            operator: exists
        then:
          - set_language:
              track_type: video
              from_plugin_metadata:
                plugin: sonarr
                field: original_language

  # Phase 5: Create an EAC3 5.1 compatibility track from lossless surround sources.
  - name: enhance
    audio_synthesis:
      tracks:
        - name: "EAC3 5.1 Compatibility"
          codec: eac3
          channels: "5.1"
          bitrate: "640k"
          skip_if_exists:
            codec: [eac3]
            channels: { gte: 6 }
            language: [eng, und]
            not_commentary: true  # Don't count commentary tracks
          source:
            prefer:
              - language: [eng, und]
              - not_commentary: true
              - codec: [truehd, "truehd atmos", "dts-hd ma", dts, flac, pcm_s24le]
              - channels: max
          create_if:
            exists:
              track_type: audio
              channels: { gte: 6 }
              language: [eng, und]
          title: "Dolby Digital Plus 5.1"
          language: inherit
          position: 1

  # Phase 6: Convert video to HEVC for space savings.
  # skip_when uses OR logic: skip if ALREADY HEVC or file is small.
  - name: compress
    skip_when:
      video_codec: [hevc, h265, x265]  # Already in efficient codec
      file_size_under: 500MB            # Small files aren't worth transcoding
    on_error: skip  # If transcode fails, skip remaining phases for this file
    transcode:
      video:
        target_codec: hevc
        quality:
          mode: crf
          crf: 20
          preset: medium
        hardware_acceleration:
          enabled: auto
          fallback_to_cpu: true
      audio:
        preserve_codecs: [truehd, "dts-hd ma", flac, pcm_s24le, eac3]
        transcode_to: aac
        transcode_bitrate: 192k

  # Phase 7: Verify transcode completed successfully.
  # run_if: only execute if the named phase actually modified the file.
  # depends_on: skip if named phases didn't complete (failed or were skipped).
  - name: verify
    run_if:
      phase_modified: compress  # Only run if compress changed the file
    depends_on: [compress]      # Skip if compress didn't complete
    conditional:
      - name: transcode_complete
        when:
          exists:
            track_type: video
        then:
          - warn: "Video transcode completed successfully"
