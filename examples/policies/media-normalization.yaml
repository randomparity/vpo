# Media Normalization Policy (V12)
# Production-ready policy for standardizing media files
#
# This policy demonstrates conditional phase execution features:
# - skip_when: Skip phases based on file characteristics
# - on_error: Per-phase error handling (skip, continue, fail)
# - run_if: Run phase only if previous phase modified file
# - depends_on: Skip phase if dependencies didn't complete
schema_version: 12
name: Full Media Normalization
description: >-
  Production pipeline: container prep, transcription analysis, track filtering,
  ordering, audio synthesis, HEVC transcoding, and post-transcode verification.

config:
  audio_language_preference: [eng, und]
  subtitle_language_preference: [eng, und]
  commentary_patterns: [commentary, director, "audio description", cast]
  on_error: skip

phases:
  # Migrate all container types to MKV
  # Skip if already in MKV format
  - name: prepare
    skip_when:
      container: [mkv]
    container:
      target: mkv
      on_incompatible_codec: transcode

  # Analyze audio tracks to detect actual language content
  # and purpose (main audio vs. commentary audio)
  # Skip for short clips (under 5 minutes) - not worth analyzing
  - name: analyze
    skip_when:
      duration_under: 5m
    on_error: continue  # Don't fail entire file if transcription fails
    transcription:
      enabled: true
      update_language_from_transcription: true
      confidence_threshold: 0.8
      detect_commentary: true

  # Clear track settings, remove unwanted language tracks
  - name: cleanup
    audio_actions:
      clear_all_forced: true
      clear_all_default: true
      clear_all_titles: false
    audio_filter:
      languages: [eng, und]
      minimum: 1
      fallback:
        mode: content_language
    subtitle_actions:
      clear_all_forced: true
      clear_all_default: true
      clear_all_titles: false
    subtitle_filter:
      languages: [eng, und]
      preserve_forced: false
    attachment_filter:
      remove_all: true

  # Organize track ordering, set track defaults
  - name: organize
    track_order:
      - video
      - audio_main
      - audio_alternate
      - audio_commentary
      - subtitle_main
      - subtitle_forced
      - subtitle_commentary
    default_flags:
      set_first_video_default: true
      set_preferred_audio_default: true
      set_preferred_subtitle_default: false
      set_subtitle_forced_when_audio_differs: true
      set_subtitle_default_when_audio_differs: true
    conditional:
      # If the plugin reports an original_language, use it for the video track
      - name: sync_video_language_from_radarr
        when:
          plugin_metadata:
            plugin: radarr
            field: original_language
            operator: exists
        then:
          - set_language:
              track_type: video
              from_plugin_metadata:
                plugin: radarr
                field: original_language

      - name: sync_video_language_from_sonarr
        when:
          plugin_metadata:
            plugin: sonarr
            field: original_language
            operator: exists
        then:
          - set_language:
              track_type: video
              from_plugin_metadata:
                plugin: sonarr
                field: original_language

  # Improve audio compatability
  - name: enhance
    audio_synthesis:
      tracks:
        - name: "EAC3 5.1 Compatibility"
          codec: eac3
          channels: "5.1"
          bitrate: "640k"
          skip_if_exists:
            codec: [eac3]
            channels: { gte: 6 }
            language: [eng, und]
            not_commentary: true
          source:
            prefer:
              - language: [eng, und]
              - not_commentary: true
              - codec: [truehd, "truehd atmos", "dts-hd ma", dts, flac, pcm_s24le]
              - channels: max
          create_if:
            exists:
              track_type: audio
              channels: { gte: 6 }
              language: [eng, und]
          title: "Dolby Digital Plus 5.1"
          language: inherit
          position: 1

  # Convert video to a more modern, space saving format
  # Skip if already HEVC or file is small (under 500MB)
  - name: compress
    skip_when:
      video_codec: [hevc, h265, x265]
      file_size_under: 500MB
    on_error: skip  # Don't process remaining phases if transcode fails
    transcode:
      video:
        target_codec: hevc
        quality:
          mode: crf
          crf: 20
          preset: medium
        hardware_acceleration:
          enabled: auto
          fallback_to_cpu: true
      audio:
        preserve_codecs: [truehd, "dts-hd ma", flac, pcm_s24le, eac3]
        transcode_to: aac
        transcode_bitrate: 192k

  # Verify transcode completed - only runs if compress phase modified the file
  - name: verify
    run_if:
      phase_modified: compress
    depends_on: [compress]
    conditional:
      - name: transcode_complete
        when:
          exists:
            track_type: video
        then:
          - warn: "Video transcode completed successfully"
