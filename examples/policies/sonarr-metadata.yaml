# Sonarr Metadata-Driven TV Policy (V13)
#
# Demonstrates using Sonarr plugin metadata in policy conditions and actions.
# Requires the sonarr-metadata plugin to be configured in ~/.vpo/config.toml.
#
# Fields available from Sonarr metadata (plugin API v1.1.0):
#   original_language        - series original language (ISO code)
#   external_title           - display title from Sonarr
#   certification            - content rating
#   genres                   - comma-separated genre list
#   network                  - broadcast network
#   series_type              - "standard", "anime", "daily"
#   runtime                  - episode runtime in minutes
#   status                   - series status (continuing, ended, etc.)
#   tvmaze_id                - TVMaze series ID
#   season_count             - number of seasons
#   total_episode_count      - total episodes across all seasons
#   monitored                - whether Sonarr is monitoring (true/false)
#   tags                     - Sonarr tag list (comma-separated)
#   absolute_episode_number  - absolute episode number (useful for anime)
#
# Usage:
#   vpo policy run -p sonarr-metadata.yaml /path/to/tv/ --dry-run
schema_version: 13
name: Sonarr TV Pipeline
description: >-
  Metadata-driven TV processing using Sonarr for anime detection,
  subtitle forcing, and smart transcoding with per-episode timestamps.

config:
  # Japanese included for anime content alongside English.
  audio_languages: [eng, jpn, und]
  subtitle_languages: [eng, jpn]
  commentary_patterns: [commentary, director, "audio description"]
  on_error: continue

phases:
  # Phase 1: Container normalization.
  - name: prepare
    skip_when:
      mode: any
      container: [mkv]
    container:
      target: mkv
      on_incompatible_codec: transcode

  # Phase 2: Metadata-driven conditional rules.
  #
  # Use Sonarr metadata to set video language, handle anime vs. standard
  # TV differently, and force subtitles for foreign-language series.
  - name: metadata
    rules:
      match: first
      items:
        # Set the video track language from Sonarr's original_language field.
        - name: set-video-language
          when:
            plugin_metadata:
              plugin: sonarr
              field: original_language
              operator: exists
          then:
            - set_language:
                track_type: video
                from_plugin_metadata:
                  plugin: sonarr
                  field: original_language

        # For anime series: force English subtitles and set them as default.
        # Anime is identified by Sonarr's series_type field (standard/anime/daily).
        - name: force-subs-for-anime
          when:
            and:
              - plugin_metadata:
                  plugin: sonarr
                  field: series_type
                  operator: eq
                  value: anime
              - exists:
                  track_type: subtitle
                  language: eng
          then:
            - set_forced:
                track_type: subtitle
                language: eng
                value: true
            - set_default:
                track_type: subtitle
                language: eng
                value: true

        # For non-anime foreign shows: force English subtitles when the
        # original language isn't English. Uses nested "and" + "not" conditions.
        - name: force-subs-for-foreign-shows
          when:
            and:
              - plugin_metadata:
                  plugin: sonarr
                  field: original_language
                  operator: neq
                  value: eng
              - not:
                  plugin_metadata:
                    plugin: sonarr
                    field: series_type
                    operator: eq
                    value: anime
              - exists:
                  track_type: subtitle
                  language: eng
          then:
            - set_forced:
                track_type: subtitle
                language: eng
                value: true

        # Warn about unmonitored series — these may be stale.
        - name: warn-unmonitored
          when:
            plugin_metadata:
              plugin: sonarr
              field: monitored
              operator: eq
              value: false
          then:
            - warn: "Series is unmonitored in Sonarr: {filename}"

        # Warn about very long-running series (100+ episodes).
        # These might benefit from a separate, more aggressive compression policy.
        - name: warn-large-series
          when:
            plugin_metadata:
              plugin: sonarr
              field: total_episode_count
              operator: gte
              value: 100
          then:
            - warn: "Large series (100+ episodes), consider dedicated policy: {filename}"

  # Phase 3: Transcoding with anime-aware skip logic.
  #
  # Standard TV gets compressed to HEVC. Anime is skipped here because
  # animated content needs tune=animation and different CRF values
  # (handled by a dedicated anime policy).
  - name: compress
    skip_when:
      mode: any
      video_codec: [hevc, h265, x265]
      file_size_under: 300MB  # Lower threshold for TV episodes (shorter than movies)
    on_error: skip
    rules:
      match: first
      items:
        # Skip video transcode for anime — animated content needs
        # tune=animation and different CRF values.
        - name: skip-anime-transcode
          when:
            plugin_metadata:
              plugin: sonarr
              field: series_type
              operator: eq
              value: anime
          then:
            - skip_video_transcode: true

        # Skip transcode for episodes tagged "4k" in Sonarr.
        - name: preserve-4k-tagged
          when:
            plugin_metadata:
              plugin: sonarr
              field: tags
              operator: contains
              value: "4k"
          then:
            - skip_video_transcode: true

    transcode:
      video:
        to: hevc
        crf: 22      # Slightly higher CRF than movies — TV tolerates more compression
        preset: medium
        max_resolution: 1080p
        scale_algorithm: lanczos
        hw: auto
        hw_fallback: true
      audio:
        preserve: [truehd, "dts-hd ma", flac, eac3]
        to: aac
        bitrate: 128k  # Lower bitrate for TV (stereo dialog is common)

  # Phase 4: Track cleanup and ordering.
  #
  # Keep English and Japanese audio for anime; English only for everything else.
  # Note: language filtering applies to all series — the jpn in the list ensures
  # anime dual-audio tracks are preserved.
  - name: organize
    keep_audio:
      languages: [eng, jpn, und]
      minimum: 1
      fallback:
        mode: content_language
    keep_subtitles:
      languages: [eng, jpn]
      preserve_forced: true
    filter_attachments:
      remove_all: false  # Keep fonts — anime often has styled ASS subtitles
    track_order:
      - video
      - audio_main
      - audio_alternate
      - audio_commentary
      - subtitle_main
      - subtitle_forced
      - subtitle_commentary
      - attachment
    default_flags:
      set_first_video_default: true
      set_preferred_audio_default: true
      set_preferred_subtitle_default: false
      # Auto-force and auto-default subtitles when the default audio track
      # is in a language other than the user's preference.
      set_subtitle_forced_when_audio_differs: true
      set_subtitle_default_when_audio_differs: true
      clear_other_defaults: true

  # Phase 5: Set file timestamp to the episode air date.
  # Sonarr provides per-episode air dates, making files sort
  # chronologically in any file manager.
  - name: timestamp
    file_timestamp:
      mode: release_date
      date_source: sonarr    # Use Sonarr-provided episode air dates
      fallback: preserve      # Keep original mtime if no air date available
