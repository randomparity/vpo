# Implementation Plan: Plans List View

**Branch**: `026-plans-list-view` | **Date**: 2025-11-25 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/026-plans-list-view/spec.md`

## Summary

Implement an Approvals/Plans page showing all pending and historical planned changes generated by dry-run policy evaluations. The page displays plans with ID, creation time, source (policy/job), file count, and status. Operators can filter by status and time range, approve/reject pending plans inline, and navigate to plan details. The list auto-refreshes via polling to show real-time updates.

**Technical Approach**: Follow the Jobs Dashboard pattern - server-rendered Jinja2 templates with vanilla JavaScript for client-side data fetching, filtering, and polling. Extend the existing `Plan` model in `policy/models.py` with a persisted `PlanRecord` in the database for the approval workflow.

## Technical Context

**Language/Version**: Python 3.10+
**Primary Dependencies**: aiohttp (server), Jinja2 (templates), vanilla JavaScript (ES6+)
**Storage**: SQLite with ISO-8601 UTC timestamps (existing `~/.vpo/library.db`)
**Testing**: pytest with pytest-aiohttp for route tests
**Target Platform**: Linux server with web browser clients
**Project Type**: Web application (server + web UI)
**Performance Goals**: Page load < 2 seconds for up to 1,000 plans (per SC-003)
**Constraints**: 50 items per page, polling interval consistent with existing patterns (5 seconds default)
**Scale/Scope**: Supports up to 1,000 plans with pagination

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Datetime Integrity | ✅ PASS | All timestamps will use ISO-8601 UTC, convert at presentation layer |
| II. Stable Identity | ✅ PASS | Plans will use UUIDv4 as primary key, not file paths |
| III. Portable Paths | ✅ PASS | Use pathlib.Path for file references, no hardcoded separators |
| IV. Versioned Schemas | ✅ PASS | New plans table will be in schema v8 with migration logic |
| V. Idempotent Operations | ✅ PASS | Approve/reject are idempotent state transitions |
| VI. IO Separation | ✅ PASS | Plan persistence in db/, UI rendering in server/, policy logic in policy/ |
| VII. Explicit Error Handling | ✅ PASS | API returns proper error responses, UI shows error states |
| VIII. Structured Logging | ✅ PASS | Log plan ID, status transitions, operator actions |
| IX. Configuration as Data | ✅ PASS | No hardcoded paths or credentials |
| X. Policy Stability | ✅ PASS | Plan record stores policy_name and policy_version for historical reference |
| XI. Plugin Isolation | N/A | No plugin interface changes |
| XII. Safe Concurrency | ✅ PASS | Use DaemonConnectionPool for thread-safe DB access via asyncio.to_thread |
| XIII. Database Design | ✅ PASS | Plans table with proper FKs, indexes, DAO pattern |
| XIV. Test Media Corpus | N/A | UI feature, not media processing |
| XV. Stable CLI/API Contracts | ✅ PASS | New REST endpoint follows existing patterns |
| XVI. Dry-Run Default | ✅ PASS | Plans ARE the dry-run output; approval required before execution |
| XVII. Data Privacy | ✅ PASS | No external service calls, no sensitive data exposure |
| XVIII. Living Documentation | ✅ PASS | Will update docs/usage/ with plans workflow |

**Gate Result**: PASS - No violations requiring justification.

## Project Structure

### Documentation (this feature)

```text
specs/026-plans-list-view/
├── plan.md              # This file
├── research.md          # Phase 0 output
├── data-model.md        # Phase 1 output
├── quickstart.md        # Phase 1 output
├── contracts/           # Phase 1 output (OpenAPI spec)
└── tasks.md             # Phase 2 output (/speckit.tasks command)
```

### Source Code (repository root)

```text
src/video_policy_orchestrator/
├── db/
│   ├── models.py        # Add PlanRecord dataclass
│   ├── operations.py    # Add plan CRUD operations
│   └── schema.py        # Add plans table (schema v8)
├── server/
│   ├── ui/
│   │   ├── routes.py    # Add plans_handler, api_plans_handler, api_plan_action_handler
│   │   ├── models.py    # Add PlanFilterParams, PlanListItem, PlanListResponse, PlansContext
│   │   └── templates/
│   │       └── sections/
│   │           └── plans.html  # New template (follow jobs.html pattern)
│   └── static/
│       └── js/
│           └── plans.js # New JavaScript module (follow jobs.js pattern)
└── policy/
    └── models.py        # Existing Plan class (no changes needed)

tests/
├── unit/
│   └── db/
│       └── test_plan_operations.py  # New tests for plan DB operations
└── integration/
    └── server/
        └── test_plans_routes.py     # New tests for plans API endpoints
```

**Structure Decision**: Web application pattern following existing Jobs Dashboard architecture. New files integrate into existing directory structure without reorganization.

## Complexity Tracking

> No constitution violations requiring justification.
