# Quickstart: Plans List View

**Feature**: 026-plans-list-view
**Date**: 2025-11-25

## Overview

This feature adds an Approvals/Plans page to the VPO web UI where operators can view, filter, and manage planned changes generated by dry-run policy evaluations.

## Key Components

### Backend (Python)

1. **Database Layer** (`db/`)
   - `PlanRecord` dataclass in `models.py`
   - Plan CRUD operations in `operations.py`
   - Schema migration v7 → v8 in `schema.py`

2. **API Layer** (`server/ui/`)
   - Filter/response models in `models.py`
   - Route handlers in `routes.py`

### Frontend (JavaScript)

3. **Templates** (`server/ui/templates/sections/`)
   - `plans.html` - Jinja2 template

4. **JavaScript** (`server/static/js/`)
   - `plans.js` - Client-side logic

## Implementation Order

```
1. Database schema (plans table)
   ↓
2. DB operations (CRUD functions)
   ↓
3. API models (filter params, list item, response)
   ↓
4. API routes (GET /api/plans, POST actions)
   ↓
5. HTML template (plans.html)
   ↓
6. JavaScript module (plans.js)
   ↓
7. Navigation integration
   ↓
8. Tests
```

## Development Commands

```bash
# Run the server
uv run vpo serve --port 8080

# Access the Plans page
open http://localhost:8080/plans

# Run tests
uv run pytest tests/unit/db/test_plan_operations.py
uv run pytest tests/integration/server/test_plans_routes.py

# Format code
uv run ruff format .
uv run ruff check .
```

## API Quick Reference

```bash
# List plans
curl http://localhost:8080/api/plans

# List pending plans only
curl "http://localhost:8080/api/plans?status=pending"

# List plans from last 24 hours
curl "http://localhost:8080/api/plans?since=24h"

# Paginate (page 2, 50 items)
curl "http://localhost:8080/api/plans?limit=50&offset=50"

# Approve a plan
curl -X POST http://localhost:8080/api/plans/{plan_id}/approve

# Reject a plan
curl -X POST http://localhost:8080/api/plans/{plan_id}/reject
```

## Key Patterns to Follow

### Database Operations

```python
# Follow existing pattern in db/operations.py
def get_plans_filtered(
    conn: sqlite3.Connection,
    status: PlanStatus | None = None,
    since: datetime | None = None,
    limit: int = 50,
    offset: int = 0,
    return_total: bool = False,
) -> tuple[list[PlanRecord], int | None]:
    """Get filtered plans with pagination."""
    # Build query with optional filters
    # Return (plans, total_count) if return_total=True
```

### API Route Handler

```python
# Follow Jobs API pattern in server/ui/routes.py
async def api_plans_handler(request: web.Request) -> web.Response:
    params = PlanFilterParams.from_query(dict(request.query))

    def _query():
        with connection_pool.transaction() as conn:
            return get_plans_filtered(conn, ...)

    plans, total = await asyncio.to_thread(_query)

    response = PlanListResponse(plans=[...], total=total, ...)
    return web.json_response(response.to_dict())
```

### JavaScript Polling

```javascript
// Follow jobs.js pattern
const pollingInstance = window.VPOPolling.create({
    fetchFn: fetchPlansForPolling,
    onStatusChange: handleConnectionStatus
});

function fetchPlansForPolling() {
    const params = new URLSearchParams({
        status: currentFilters.status,
        since: currentFilters.since,
        limit: pageSize,
        offset: currentOffset
    });
    return fetch(`/api/plans?${params}`).then(r => r.json());
}
```

## File Locations

| Component | Path |
|-----------|------|
| DB Model | `src/vpo/db/models.py` |
| DB Operations | `src/vpo/db/operations.py` |
| DB Schema | `src/vpo/db/schema.py` |
| API Models | `src/vpo/server/ui/models.py` |
| API Routes | `src/vpo/server/ui/routes.py` |
| Template | `src/vpo/server/ui/templates/sections/plans.html` |
| JavaScript | `src/vpo/server/static/js/plans.js` |
| Unit Tests | `tests/unit/db/test_plan_operations.py` |
| Integration Tests | `tests/integration/server/test_plans_routes.py` |

## Reference Files

Study these existing implementations:

1. **Jobs Dashboard** - Most similar feature
   - `server/ui/templates/sections/jobs.html`
   - `server/static/js/jobs.js`
   - Route handlers in `server/ui/routes.py` (lines 162-304)

2. **Polling Module**
   - `server/static/js/polling.js`

3. **DB Patterns**
   - `db/models.py` - OperationRecord pattern
   - `db/operations.py` - Query patterns

4. **API Models**
   - `server/ui/models.py` - JobFilterParams, JobListItem, JobListResponse
