# Data Model: VPO Init Command

**Date**: 2025-11-25
**Feature**: 030-init-command

## Overview

The init command creates static configuration files, not database entities. This document describes the file structures and their relationships.

## Entities

### 1. InitializationState

Represents the current state of VPO initialization at a given path.

```python
@dataclass
class InitializationState:
    """Result of checking initialization status."""

    data_dir: Path
    """Target data directory path."""

    is_initialized: bool
    """True if config.toml exists."""

    config_exists: bool
    """True if config.toml file exists."""

    policies_dir_exists: bool
    """True if policies/ directory exists."""

    plugins_dir_exists: bool
    """True if plugins/ directory exists."""

    default_policy_exists: bool
    """True if policies/default.yaml exists."""

    has_partial_state: bool
    """True if directory exists but is incomplete."""

    existing_files: list[Path]
    """List of existing files/directories that would be affected."""
```

**State Transitions**:
```
                    +------------------+
                    | Not Initialized  |
                    | (no ~/.vpo/)     |
                    +--------+---------+
                             |
                    vpo init |
                             v
                    +------------------+
                    | Fully Initialized|
                    | (all files exist)|
                    +--------+---------+
                             |
                 vpo init    |  vpo init --force
                 (no-op)     |  (overwrites)
                             v
                    +------------------+
                    | Fully Initialized|
                    | (refreshed)      |
                    +------------------+
```

### 2. InitResult

Represents the outcome of an initialization operation.

```python
@dataclass
class InitResult:
    """Result of running init command."""

    success: bool
    """True if initialization completed successfully."""

    data_dir: Path
    """Path where initialization occurred."""

    created_files: list[Path]
    """Files that were created."""

    created_directories: list[Path]
    """Directories that were created."""

    skipped_files: list[Path]
    """Files that already existed (with --force, these were overwritten)."""

    error: str | None
    """Error message if success is False."""

    dry_run: bool
    """True if this was a dry-run (no files actually created)."""
```

### 3. ConfigTemplate

Represents the config.toml template structure.

```python
# Not a runtime dataclass - this is the generated file structure

# File: ~/.vpo/config.toml
# Generated by: vpo init
# Format: TOML with inline documentation comments

SECTIONS = [
    "tools",           # External tool paths
    "tools.detection", # Tool capability caching
    "behavior",        # Runtime warnings
    "plugins",         # Plugin configuration
    "jobs",            # Job system settings
    "worker",          # Worker limits
    "transcription",   # Whisper settings
    "logging",         # Log configuration
    "server",          # Web UI settings
    "language",        # Language code standard
]
```

## File Structures

### config.toml Structure

```toml
# Video Policy Orchestrator Configuration
# Generated by: vpo init
# Documentation: https://github.com/randomparity/vpo
#
# This file controls VPO's behavior. Uncomment and modify settings as needed.
# Environment variables (VPO_*) take precedence over this file.

# ============================================================================
# Tool Paths
# ============================================================================
# Explicit paths to external tools. If not set, VPO searches PATH.

[tools]
# ffmpeg = "/usr/local/bin/ffmpeg"
# ffprobe = "/usr/local/bin/ffprobe"
# mkvmerge = "/usr/local/bin/mkvmerge"
# mkvpropedit = "/usr/local/bin/mkvpropedit"

[tools.detection]
# cache_ttl_hours = 24        # How long to cache tool capability info
# auto_detect_on_startup = true

# ============================================================================
# Behavior
# ============================================================================

[behavior]
# warn_on_missing_features = true   # Warn when features unavailable
# show_upgrade_suggestions = true   # Suggest tool upgrades

# ... (additional sections follow same pattern)
```

### policies/default.yaml Structure

```yaml
# Default Policy for Video Policy Orchestrator
# Generated by: vpo init
# Usage: vpo apply --policy ~/.vpo/policies/default.yaml <file.mkv>

schema_version: 1

track_order:
  - video
  - audio_main
  - audio_alternate
  - subtitle_main
  - subtitle_forced
  - audio_commentary
  - subtitle_commentary
  - attachment

audio_language_preference:
  - eng
  - und

subtitle_language_preference:
  - eng
  - und

commentary_patterns:
  - 'commentary'
  - 'director'

default_flags:
  set_first_video_default: true
  set_preferred_audio_default: true
  set_preferred_subtitle_default: false
  clear_other_defaults: true
```

## Relationships

```
VPO Data Directory (~/.vpo/)
├── config.toml         # 1:1 - One config per data directory
├── policies/           # 1:N - Directory can contain multiple policies
│   └── default.yaml    # Created by init; user can add more
├── plugins/            # 1:N - Directory can contain multiple plugins
├── library.db          # Created by scan, not init
└── logs/               # Created on-demand by logging system
```

## Validation Rules

### Path Validation

1. **Data directory path**:
   - Must be writable by current user
   - Must not be an existing file
   - Parent directory must exist or be creatable

2. **Config file**:
   - Must be valid TOML syntax
   - All uncommented settings must have valid values

3. **Policy file**:
   - Must have `schema_version: 1`
   - Must be valid YAML syntax

### Initialization Validation

| Condition | Action |
|-----------|--------|
| Path is file | Error: "A file already exists at this location" |
| No write permission | Error: "Permission denied" |
| Parent doesn't exist | Create parent directories |
| Config exists, no --force | Error: "Already initialized, use --force" |
| Config exists, with --force | Overwrite, report what was replaced |

## No Database Entities

This feature does not create or modify database tables. The SQLite database (`library.db`) is created on first `vpo scan` operation.
