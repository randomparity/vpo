# Pre-Commit Hooks Summary

This document describes the pre-commit hooks configured for VPO.

## Installation

```bash
# Install hooks for commit-time checks
uv run pre-commit install

# Install hooks for pre-push checks
uv run pre-commit install --hook-type pre-push

# Run all hooks manually
uv run pre-commit run --all-files
```

## Configured Hooks

### 1. Standard File Hygiene
**Runs on**: Every commit
**Source**: `pre-commit/pre-commit-hooks`

- `trailing-whitespace` - Remove trailing whitespace
- `end-of-file-fixer` - Ensure files end with newline
- `check-yaml` - Validate YAML syntax
- `check-toml` - Validate TOML syntax
- `check-json` - Validate JSON syntax
- `check-added-large-files` - Prevent files >1MB from being committed
- `check-merge-conflict` - Detect merge conflict markers
- `detect-private-key` - Prevent committing private keys
- `check-case-conflict` - Check for case conflicts in filenames
- `mixed-line-ending` - Enforce LF line endings

### 2. Python Quality (Ruff)
**Runs on**: Every commit
**Source**: `astral-sh/ruff-pre-commit`

- `ruff-format` - Format Python code
- `ruff` - Lint Python code with auto-fix

### 3. Rust Quality
**Runs on**: Every commit
**Type**: Local hooks

- `cargo-fmt` - Format Rust code
- `cargo-clippy` - Lint Rust code (treats warnings as errors)

### 4. JavaScript Quality (ESLint)
**Runs on**: Every commit
**Source**: `pre-commit/mirrors-eslint`

- Lints JavaScript files in `src/video_policy_orchestrator/server/static/js/`
- Auto-fixes issues where possible
- Enforces standard JavaScript style guide
- Configuration in `.eslintrc.json`

**Style Enforced**:
- 4-space indentation
- Single quotes (with escape allowance)
- No semicolons
- ES2021+ features
- Module imports

### 5. Security Scanning (Bandit)
**Runs on**: Every commit
**Source**: `PyCQA/bandit`

- Scans Python code for common security issues
- Configuration in `pyproject.toml` under `[tool.bandit]`
- Excludes test files
- Checks for:
  - SQL injection vulnerabilities
  - Shell injection risks
  - Hardcoded passwords/secrets
  - Insecure random number generation
  - Unsafe YAML loading
  - And more...

**Skipped Checks**:
- B101 (assert_used) - asserts are OK in our codebase
- B602 (subprocess_popen_with_shell_equals_true) - needed for some operations

### 6. Secrets Detection
**Runs on**: Every commit
**Source**: `Yelp/detect-secrets`

- Scans for accidentally committed secrets
- Uses baseline file `.secrets.baseline`
- Detects:
  - API keys
  - AWS credentials
  - GitHub tokens
  - Private keys
  - High-entropy strings
  - And more...

**To update baseline**:
```bash
uv run detect-secrets scan --baseline .secrets.baseline
```

### 7. Pre-Push Tests
**Runs on**: Git push only
**Type**: Local hooks

- `pytest-unit` - Run all unit tests
- `cargo-check` - Verify Rust code compiles

## Troubleshooting

### Skipping Hooks (Emergency Use Only)
```bash
# Skip all hooks (NOT RECOMMENDED)
git commit --no-verify

# Skip specific hook
SKIP=eslint git commit -m "message"
```

### Updating Hooks
```bash
uv run pre-commit autoupdate
```

### Running Specific Hooks
```bash
# Run only Python linting
uv run pre-commit run ruff --all-files

# Run only security checks
uv run pre-commit run bandit --all-files

# Run only JavaScript linting
uv run pre-commit run eslint --all-files
```

## Security Benefits

The enhanced pre-commit hooks provide:

1. **Automated Security Scanning**: Every commit is checked for common vulnerabilities
2. **Secrets Prevention**: Stops accidental credential commits before they reach the repo
3. **Code Quality**: Consistent style and best practices across Python, Rust, and JavaScript
4. **Early Detection**: Catches issues at commit time, not in CI/PR review
5. **Defense in Depth**: Multiple layers of validation (linting, security, testing)

## Files Created/Modified

- `.pre-commit-config.yaml` - Main configuration
- `.eslintrc.json` - JavaScript linting rules
- `.eslintignore` - Files to exclude from JS linting
- `.secrets.baseline` - Baseline for secret detection
- `pyproject.toml` - Added `[tool.bandit]` section and dev dependencies
