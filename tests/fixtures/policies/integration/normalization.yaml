# Media Normalization Policy
#
# A production-ready policy for standardizing media file formats:
# 1. Convert all videos to MKV containers
# 2. Transcode non-x265 video to x265 (skip if already compliant)
# 3. Create EAC3 5.1 from lossless sources (or use existing)
# 4. Keep original lossless audio alongside synthesized EAC3
# 5. Remove non-English audio (with fallback to content language)
# 6. Remove non-English subtitles
# 7. Set English subtitle as forced when audio is foreign/multi-language
# 8. Remove attachments (cover art, fonts)

schema_version: 13

config:
  audio_languages: [eng, und]
  subtitle_languages: [eng, und]
  commentary_patterns:
    - commentary
    - director
    - "audio description"
    - cast

phases:
  - name: container
    # Req 1: Convert to MKV container
    container:
      target: mkv
      on_incompatible_codec: transcode

  - name: transcode
    # Req 2: Transcode non-x265 to x265
    transcode:
      video:
        to: hevc
        skip_if:
          codec_matches: [hevc, h265, x265]
        crf: 20
        preset: medium
        hw: auto
        hw_fallback: true
      audio:
        # Preserve lossless codecs (Req 4: keep originals)
        preserve: [truehd, "dts-hd ma", flac, pcm_s24le, eac3]
        to: aac
        bitrate: 192k

  - name: synthesis
    # Reqs 3 & 4: Create EAC3 5.1 from lossless (or use existing)
    audio_synthesis:
      tracks:
        - name: "EAC3 5.1 Compatibility"
          codec: eac3
          channels: "5.1"
          bitrate: "640k"
          # Skip synthesis if suitable EAC3 already exists
          skip_if_exists:
            codec: [eac3]
            channels: { gte: 6 }
            language: [eng, und]
            not_commentary: true
          source:
            prefer:
              - language: [eng, und]
              - not_commentary: true
              - codec: [truehd, "dts-hd ma", flac, pcm_s24le]
              - channels: max
          # Only create if there's a multi-channel source
          create_if:
            exists:
              track_type: audio
              channels: { gte: 6 }
              language: [eng, und]
          title: "Dolby Digital Plus 5.1"
          language: inherit
          position: 1

  - name: filter
    # Req 6: Remove non-English audio with fallback
    keep_audio:
      languages: [eng, und]
      minimum: 1
      fallback:
        mode: content_language
    # Req 7: Remove non-English subtitles
    keep_subtitles:
      languages: [eng, und]
      preserve_forced: true
    # Req 9: Remove attachments (cover art, fonts)
    filter_attachments:
      remove_all: true

  - name: organize
    track_order:
      - video
      - audio_main
      - audio_alternate
      - subtitle_main
      - subtitle_forced
      - audio_commentary
      - subtitle_commentary
    # Req 8: Force English subs when audio is multi-language/non-English
    rules:
      match: first
      items:
        - name: force_english_subs_for_foreign_audio
          when:
            or:
              - audio_is_multi_language:
                  threshold: 0.05
              - not:
                  exists:
                    track_type: audio
                    language: eng
                    is_default: true
          then:
            - set_forced:
                track_type: subtitle
                language: eng
                value: true
    default_flags:
      set_first_video_default: true
      set_preferred_audio_default: true
      set_preferred_subtitle_default: false
      clear_other_defaults: true
