# Complete Phased Policy Fixture
# Used to test all operation types across phases
schema_version: 13

config:
  audio_languages: [eng, jpn, und]
  subtitle_languages: [eng, jpn]
  commentary_patterns: [commentary, director, "audio description"]
  on_error: continue

phases:
  - name: prepare
    container:
      target: mkv

  - name: cleanup
    keep_audio:
      languages: [eng, jpn, und]
      minimum: 1
      fallback:
        mode: keep_first
    keep_subtitles:
      languages: [eng, jpn]
      preserve_forced: true
    filter_attachments:
      remove_all: false

  - name: organize
    track_order:
      - video
      - audio_main
      - audio_alternate
      - audio_commentary
      - subtitle_main
      - subtitle_forced
      - subtitle_commentary
    default_flags:
      set_first_video_default: true
      set_preferred_audio_default: true
    rules:
      match: first
      items:
        - name: force-subs-for-foreign
          when:
            not:
              exists:
                track_type: audio
                language: eng
          then:
            - set_forced:
                track_type: subtitle
                language: eng
                value: true

  - name: enhance
    audio_synthesis:
      tracks:
        - name: "AAC Stereo"
          codec: aac
          channels: stereo
          bitrate: "192k"
          skip_if_exists:
            codec: aac
            channels: 2
          source:
            prefer:
              - codec: [truehd, dts-hd, flac]
              - codec: [dts, ac3]

  - name: transcode
    transcode:
      video:
        to: hevc
        skip_if:
          codec_matches: [hevc, h265]
          resolution_within: 1080p
          bitrate_under: 15M
        crf: 20
        preset: medium
        max_resolution: 1080p
        scale_algorithm: lanczos
        hw: auto
        hw_fallback: true
      audio:
        preserve: [truehd, dts-hd, flac, aac]
        to: aac
        bitrate: 128k

  - name: analyze
    transcription:
      enabled: true
