{% extends "base.html" %}

{% block content %}
<div class="file-detail">
    <!-- Back navigation -->
    <a href="{{ back_url }}" class="file-detail-back">&larr; Back to Library</a>

    <!-- File header -->
    <header class="file-detail-header">
        <h1 class="file-detail-title" title="{{ file.path }}">{{ file.filename }}</h1>
        {% if file.scan_status == 'error' %}
        <span class="status-badge status-badge--failed">scan error</span>
        {% endif %}
    </header>

    <!-- Scan error message (if failed) -->
    {% if file.scan_error %}
    <section class="file-detail-error">
        <h2>Scan Error</h2>
        <div class="file-detail-error-message">{{ file.scan_error }}</div>
    </section>
    {% endif %}

    <!-- File information section (US3) -->
    <section class="file-detail-info">
        <h2>File Information</h2>
        <dl class="file-detail-dl">
            <div class="file-detail-dl-row">
                <dt>Filename</dt>
                <dd class="file-detail-path" title="{{ file.filename }}">{{ file.filename }}</dd>
            </div>
            <div class="file-detail-dl-row">
                <dt>Directory</dt>
                <dd class="file-detail-path" title="{{ file.directory }}">{{ file.directory }}</dd>
            </div>
            {% if file.container_format %}
            <div class="file-detail-dl-row">
                <dt>Container</dt>
                <dd>{{ file.container_format }}</dd>
            </div>
            {% endif %}
            {% if file.has_container_tags %}
            <div class="file-detail-dl-row file-detail-dl-row--tags">
                <dt>Container Tags</dt>
                <dd>
                    <dl class="file-detail-tags-dl" aria-label="Container metadata tags">
                        {% for key, value in file.container_tags | dictsort %}
                        <div class="file-detail-tags-row">
                            <dt>{{ key }}</dt>
                            <dd>{{ value }}</dd>
                        </div>
                        {% endfor %}
                    </dl>
                </dd>
            </div>
            {% endif %}
            <div class="file-detail-dl-row">
                <dt>Size</dt>
                <dd>{{ file.size_human }} ({{ file.size_bytes | string | format_number }} bytes)</dd>
            </div>
            <div class="file-detail-dl-row">
                <dt>Modified</dt>
                <dd><time data-timestamp="{{ file.modified_at }}" datetime="{{ file.modified_at }}">{{ file.modified_at }}</time></dd>
            </div>
            <div class="file-detail-dl-row">
                <dt>Scanned</dt>
                <dd><time data-timestamp="{{ file.scanned_at }}" datetime="{{ file.scanned_at }}">{{ file.scanned_at }}</time></dd>
            </div>
        </dl>
    </section>

    <!-- Enriched metadata section (from Radarr/Sonarr) -->
    {% if file.external_source %}
    <section class="file-detail-enrichment">
        <h2>
            External Metadata
            <span class="status-badge status-badge--{{ file.external_source }}">{{ file.external_source }}</span>
        </h2>
        <dl class="file-detail-dl">
            {% if file.external_title %}
            <div class="file-detail-dl-row">
                <dt>Title</dt>
                <dd>{{ file.external_title }}{% if file.external_year %} ({{ file.external_year }}){% endif %}</dd>
            </div>
            {% endif %}
            {% if file.original_language %}
            <div class="file-detail-dl-row">
                <dt>Original Language</dt>
                <dd>{{ file.original_language }}</dd>
            </div>
            {% endif %}
            {% if file.series_title %}
            <div class="file-detail-dl-row">
                <dt>Series</dt>
                <dd>{{ file.series_title }}</dd>
            </div>
            {% endif %}
            {% if file.season_number is not none and file.episode_number is not none %}
            <div class="file-detail-dl-row">
                <dt>Episode</dt>
                <dd>S{{ '%02d' % file.season_number }}E{{ '%02d' % file.episode_number }}{% if file.episode_title %} - {{ file.episode_title }}{% endif %}</dd>
            </div>
            {% endif %}
            {% if file.imdb_id %}
            <div class="file-detail-dl-row">
                <dt>IMDb</dt>
                <dd><a href="https://www.imdb.com/title/{{ file.imdb_id }}" target="_blank" rel="noopener">{{ file.imdb_id }}</a></dd>
            </div>
            {% endif %}
            {% if file.tmdb_id %}
            <div class="file-detail-dl-row">
                <dt>TMDb</dt>
                {% if file.external_source == 'sonarr' %}
                <dd><a href="https://www.themoviedb.org/tv/{{ file.tmdb_id }}" target="_blank" rel="noopener">{{ file.tmdb_id }}</a></dd>
                {% else %}
                <dd><a href="https://www.themoviedb.org/movie/{{ file.tmdb_id }}" target="_blank" rel="noopener">{{ file.tmdb_id }}</a></dd>
                {% endif %}
            </div>
            {% endif %}
            {% if file.tvdb_id %}
            <div class="file-detail-dl-row">
                <dt>TVDb</dt>
                <dd><a href="https://thetvdb.com/dereferrer/series/{{ file.tvdb_id }}" target="_blank" rel="noopener">{{ file.tvdb_id }}</a></dd>
            </div>
            {% endif %}
        </dl>
    </section>
    {% endif %}

    <!-- Scan job link (US4) -->
    {% if file.scan_job_id %}
    <section class="file-detail-jobs">
        <h2>Related Jobs</h2>
        <dl class="file-detail-dl">
            <div class="file-detail-dl-row">
                <dt>Scan Job</dt>
                <dd><a href="/jobs/{{ file.scan_job_id }}" class="file-detail-job-link">{{ file.scan_job_id[:8] }}...</a></dd>
            </div>
        </dl>
    </section>
    {% endif %}

    <!-- Plugin metadata section (236-generic-plugin-data-browser) -->
    {% if file.has_plugin_data %}
    <section class="file-detail-plugins">
        <h2>Plugin Data</h2>
        <div class="plugin-data-summary">
            <p>{{ file.plugin_count }} plugin{% if file.plugin_count != 1 %}s{% endif %} have provided data for this file.</p>
            <ul class="plugin-list">
                {% for plugin_name, data in file.plugin_metadata.items() %}
                <li class="plugin-list-item">
                    <strong>{{ plugin_name }}</strong>: {{ data | length }} field{% if data | length != 1 %}s{% endif %}
                </li>
                {% endfor %}
            </ul>
            <a href="/library/{{ file.id }}/plugins" class="plugin-data-link" aria-label="View all plugin data for {{ file.filename }}">View All Plugin Data <span aria-hidden="true">&rarr;</span></a>
        </div>
    </section>
    {% endif %}

    <!-- Video tracks section (US2) -->
    {% if file.video_tracks %}
    <section class="file-detail-tracks {% if file.has_many_tracks %}collapsible{% endif %}" data-track-type="video">
        <h2>
            {% if file.has_many_tracks %}
            <button type="button" class="collapsible-header" aria-expanded="true" aria-controls="video-tracks-content">
                <span class="collapse-icon" aria-hidden="true">▼</span>
                Video Tracks ({{ file.video_tracks | length }})
            </button>
            {% else %}
            Video Tracks ({{ file.video_tracks | length }})
            {% endif %}
        </h2>
        <div id="video-tracks-content" class="track-list {% if file.has_many_tracks %}collapsible-content{% endif %}">
            {% for track in file.video_tracks %}
            <div class="track-item track-item--video">
                <div class="track-header">
                    <span class="track-index">#{{ track.index }}</span>
                    <span class="track-codec">{{ track.codec or '—' }}</span>
                    {% if track.is_default %}<span class="track-flag track-flag--default">default</span>{% endif %}
                    {% if track.is_forced %}<span class="track-flag track-flag--forced">forced</span>{% endif %}
                </div>
                <div class="track-details">
                    {% if track.resolution %}
                    <span class="track-detail"><strong>Resolution:</strong> {{ track.resolution }}</span>
                    {% endif %}
                    {% if track.frame_rate %}
                    <span class="track-detail"><strong>Frame Rate:</strong> {{ track.frame_rate }} fps</span>
                    {% endif %}
                    {% if track.title %}
                    <span class="track-detail"><strong>Title:</strong> {{ track.title }}</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <!-- Audio tracks section (US2, US5) -->
    {% if file.audio_tracks %}
    <section class="file-detail-tracks {% if file.has_many_tracks %}collapsible{% endif %}" data-track-type="audio">
        <h2>
            {% if file.has_many_tracks %}
            <button type="button" class="collapsible-header" aria-expanded="true" aria-controls="audio-tracks-content">
                <span class="collapse-icon" aria-hidden="true">▼</span>
                Audio Tracks ({{ file.audio_tracks | length }})
            </button>
            {% else %}
            Audio Tracks ({{ file.audio_tracks | length }})
            {% endif %}
        </h2>
        <div id="audio-tracks-content" class="track-list {% if file.has_many_tracks %}collapsible-content{% endif %}">
            {% for track in file.audio_tracks %}
            <div class="track-item track-item--audio">
                <div class="track-header">
                    <span class="track-index">#{{ track.index }}</span>
                    <span class="track-codec">{{ track.codec or '—' }}</span>
                    {% if track.language %}<span class="track-language">{{ track.language }}</span>{% endif %}
                    {% if track.is_default %}<span class="track-flag track-flag--default">default</span>{% endif %}
                    {% if track.is_forced %}<span class="track-flag track-flag--forced">forced</span>{% endif %}
                </div>
                <div class="track-details">
                    {% if track.channels %}
                    <span class="track-detail"><strong>Channels:</strong> {{ track.channels }}{% if track.channel_layout %} ({{ track.channel_layout }}){% endif %}</span>
                    {% endif %}
                    {% if track.title %}
                    <span class="track-detail"><strong>Title:</strong> {{ track.title }}</span>
                    {% endif %}
                    {% if track.transcription %}
                    <a href="/transcriptions/{{ track.transcription.id }}" class="track-detail track-detail--transcription track-detail--link">
                        <strong>Detected:</strong> {{ track.transcription.detected_language or '—' }}
                        ({{ track.transcription.confidence_percent }}% confidence, {{ track.transcription.track_type }})
                    </a>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <!-- Subtitle tracks section (US2) -->
    {% if file.subtitle_tracks %}
    <section class="file-detail-tracks {% if file.has_many_tracks %}collapsible{% endif %}" data-track-type="subtitle">
        <h2>
            {% if file.has_many_tracks %}
            <button type="button" class="collapsible-header" aria-expanded="true" aria-controls="subtitle-tracks-content">
                <span class="collapse-icon" aria-hidden="true">▼</span>
                Subtitle Tracks ({{ file.subtitle_tracks | length }})
            </button>
            {% else %}
            Subtitle Tracks ({{ file.subtitle_tracks | length }})
            {% endif %}
        </h2>
        <div id="subtitle-tracks-content" class="track-list {% if file.has_many_tracks %}collapsible-content{% endif %}">
            {% for track in file.subtitle_tracks %}
            <div class="track-item track-item--subtitle">
                <div class="track-header">
                    <span class="track-index">#{{ track.index }}</span>
                    <span class="track-codec">{{ track.codec or '—' }}</span>
                    {% if track.language %}<span class="track-language">{{ track.language }}</span>{% endif %}
                    {% if track.is_default %}<span class="track-flag track-flag--default">default</span>{% endif %}
                    {% if track.is_forced %}<span class="track-flag track-flag--forced">forced</span>{% endif %}
                </div>
                <div class="track-details">
                    {% if track.title %}
                    <span class="track-detail"><strong>Title:</strong> {{ track.title }}</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <!-- Other tracks section (attachments, etc.) -->
    {% if file.other_tracks %}
    <section class="file-detail-tracks {% if file.has_many_tracks %}collapsible{% endif %}" data-track-type="other">
        <h2>
            {% if file.has_many_tracks %}
            <button type="button" class="collapsible-header" aria-expanded="true" aria-controls="other-tracks-content">
                <span class="collapse-icon" aria-hidden="true">▼</span>
                Other Tracks ({{ file.other_tracks | length }})
            </button>
            {% else %}
            Other Tracks ({{ file.other_tracks | length }})
            {% endif %}
        </h2>
        <div id="other-tracks-content" class="track-list {% if file.has_many_tracks %}collapsible-content{% endif %}">
            {% for track in file.other_tracks %}
            <div class="track-item track-item--other">
                <div class="track-header">
                    <span class="track-index">#{{ track.index }}</span>
                    <span class="track-type">{{ track.track_type }}</span>
                    <span class="track-codec">{{ track.codec or '—' }}</span>
                </div>
                <div class="track-details">
                    {% if track.title %}
                    <span class="track-detail"><strong>Title:</strong> {{ track.title }}</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <!-- Empty state: no tracks -->
    {% if file.total_tracks == 0 %}
    <section class="file-detail-empty">
        <p>No track information available for this file.</p>
    </section>
    {% endif %}
</div>

<script src="/static/js/file-detail.js"></script>
{% endblock %}
