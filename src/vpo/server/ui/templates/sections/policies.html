{% extends "base.html" %}

{% block content %}
<div class="policies-section">
    {# Header with Create New Policy button #}
    <div class="policies-header">
        <div class="policies-info" role="status">
            Policies directory: <code>{{ policies_context.policies_directory }}</code>
        </div>
        <button type="button" id="create-policy-btn" class="btn btn-primary">
            + Create New Policy
        </button>
    </div>

    {% if policies_response.default_policy_missing %}
    {# Warning: Default policy configured but file not found #}
    <div class="policies-warning" role="alert">
        Warning: Default policy <code>{{ policies_response.default_policy_path }}</code> is configured but the file was not found.
    </div>
    {% elif not policies_response.default_policy_path and policies_response.total > 0 %}
    {# Info: No default policy configured #}
    <div class="policies-info-secondary" role="status">
        No default policy configured. Set <code>default_policy</code> in your profile to designate a policy as the default.
    </div>
    {% endif %}

    {% if not policies_response.directory_exists %}
    {# Directory doesn't exist #}
    <div class="policies-empty" role="status">
        <p>Policies directory does not exist.</p>
        <p class="placeholder-hint">Create <code>{{ policies_context.policies_directory }}</code> and add YAML policy files to get started.</p>
    </div>
    {% elif policies_response.total == 0 %}
    {# Directory exists but is empty #}
    <div class="policies-warning" role="alert">
        <p>No policy files found.</p>
        <p class="placeholder-hint">Add <code>.yaml</code> or <code>.yml</code> policy files to <code>{{ policies_context.policies_directory }}</code></p>
    </div>
    {% else %}
    {# Category filter #}
    <div class="policies-filters">
        <label for="filter-category">Category:</label>
        <select id="filter-category" class="filter-select" aria-label="Filter by category">
            <option value="">All Categories</option>
        </select>
    </div>

    {# Display policies table #}
    <div class="policies-table-container">
        <table class="policies-table" aria-label="Policy files list">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Category</th>
                    <th>Version</th>
                    <th>Audio Languages</th>
                    <th>Subtitle Languages</th>
                    <th>Features</th>
                    <th>Modified</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for policy in policies_response.policies %}
                <tr class="{% if policy.parse_error %}policy-error{% endif %}" data-category="{{ (policy.category or '')|e }}">
                    <td class="policy-name">
                        {{ policy.name }}
                        {% if policy.is_default %}
                        <span class="badge badge-default" aria-label="Default policy">Default</span>
                        {% endif %}
                        {% if policy.parse_error %}
                        <span class="badge badge-error" title="{{ policy.parse_error }}" aria-label="Parse error">Error</span>
                        {% endif %}
                    </td>
                    <td class="policy-description" title="{{ (policy.description or '')|e }}">
                        {% if policy.description %}
                        {{ policy.description[:50] }}{% if policy.description|length > 50 %}...{% endif %}
                        {% else %}
                        &mdash;
                        {% endif %}
                    </td>
                    <td class="policy-category">
                        {% if policy.category %}
                        <span class="badge badge-category">{{ policy.category }}</span>
                        {% else %}
                        &mdash;
                        {% endif %}
                    </td>
                    <td class="policy-version">
                        {% if policy.schema_version %}
                        v{{ policy.schema_version }}
                        {% else %}
                        &mdash;
                        {% endif %}
                    </td>
                    <td class="policy-languages">{{ policy.audio_languages }}</td>
                    <td class="policy-languages">{{ policy.subtitle_languages }}</td>
                    <td class="policy-features">
                        {% if policy.has_transcode %}
                        <span class="badge badge-transcode">Transcode</span>
                        {% endif %}
                        {% if policy.has_transcription %}
                        <span class="badge badge-transcription">Transcription</span>
                        {% endif %}
                        {% if not policy.has_transcode and not policy.has_transcription and not policy.parse_error %}
                        &mdash;
                        {% endif %}
                    </td>
                    <td class="policy-modified" title="{{ policy.file_path }}">
                        <span class="relative-time" data-timestamp="{{ policy.last_modified }}">{{ policy.last_modified }}</span>
                    </td>
                    <td class="policy-actions">
                        {% if not policy.parse_error %}
                        <a href="/policies/{{ policy.name }}/edit" class="btn-action" title="Edit policy">Edit</a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="policies-count" role="status" aria-live="polite">
        Showing {{ policies_response.total }} polic{{ 'y' if policies_response.total == 1 else 'ies' }}
    </div>
    {% endif %}

    {# Create New Policy Dialog #}
    <dialog id="create-policy-dialog" class="create-policy-dialog" aria-labelledby="dialog-title" aria-modal="true">
        <form id="create-policy-form" method="dialog">
            <h2 id="dialog-title">Create New Policy</h2>

            <div class="form-group">
                <label for="policy-name">Policy Name</label>
                <input type="text"
                       id="policy-name"
                       name="name"
                       pattern="^[a-zA-Z0-9_-]+$"
                       placeholder="my-policy"
                       required
                       autocomplete="off"
                       aria-describedby="name-help">
                <small id="name-help" class="form-hint">
                    Letters, numbers, dashes, and underscores only.
                </small>
            </div>

            <div class="form-group">
                <label for="policy-description">Description (optional)</label>
                <input type="text"
                       id="policy-description"
                       name="description"
                       placeholder="Brief description of this policy"
                       autocomplete="off">
            </div>

            <div class="form-group">
                <label for="policy-category">Category (optional)</label>
                <select id="policy-category" name="category" aria-describedby="category-help">
                    <option value="">No category</option>
                    <option value="organize">organize</option>
                    <option value="transcode">transcode</option>
                    <option value="archive">archive</option>
                    <option value="streaming">streaming</option>
                    <option value="custom">custom</option>
                </select>
                <small id="category-help" class="form-hint">
                    Group policies by purpose.
                </small>
            </div>

            <div id="create-policy-error" class="form-error" role="alert" hidden></div>

            <div class="dialog-actions">
                <button type="button" id="cancel-create-btn" class="btn btn-secondary">Cancel</button>
                <button type="submit" id="submit-create-btn" class="btn btn-primary">Create Policy</button>
            </div>
        </form>
    </dialog>
</div>
<script src="/static/js/policies.js"></script>
{% endblock %}
