{% extends "base.html" %}

{% block content %}
<div class="stats-dashboard">
    <!-- Loading state -->
    <div id="stats-loading" class="stats-loading" role="status" aria-label="Loading statistics">
        <div class="stats-loading-spinner" aria-hidden="true"></div>
        <p>Loading statistics...</p>
    </div>

    <!-- Error state (hidden by default) -->
    <div id="stats-error" class="stats-error initially-hidden" role="alert">
        <div class="stats-error-icon" aria-hidden="true">!</div>
        <div class="stats-error-title">Error loading statistics</div>
        <div class="stats-error-message" id="stats-error-message">Failed to load statistics.</div>
        <button class="stats-retry-btn" id="stats-retry-btn" type="button">Retry</button>
    </div>

    <!-- Main content (hidden until loaded) -->
    <div id="stats-content" class="initially-hidden">
        <!-- Time filter -->
        <div class="stats-filters">
            <label for="stats-time-filter">Time range:</label>
            <select id="stats-time-filter">
                <option value="">All time</option>
                <option value="24h">Last 24 hours</option>
                <option value="7d" selected>Last 7 days</option>
                <option value="30d">Last 30 days</option>
                <option value="90d">Last 90 days</option>
            </select>
        </div>

        <!-- Summary cards -->
        <div class="stats-summary-cards">
            <div class="stats-card stats-card-primary">
                <div class="stats-card-title">Files Processed</div>
                <div class="stats-card-value" id="stats-files-processed">0</div>
                <div class="stats-card-detail">
                    <span id="stats-success-count">0</span> successful,
                    <span id="stats-fail-count">0</span> failed
                </div>
            </div>
            <div class="stats-card stats-card-success">
                <div class="stats-card-title">Space Saved</div>
                <div class="stats-card-value" id="stats-space-saved">0 B</div>
                <div class="stats-card-detail">
                    <span id="stats-avg-savings">0%</span> average savings
                </div>
            </div>
            <div class="stats-card stats-card-info">
                <div class="stats-card-title">Tracks Removed</div>
                <div class="stats-card-value" id="stats-tracks-removed">0</div>
                <div class="stats-card-detail">
                    <span id="stats-audio-removed">0</span> audio,
                    <span id="stats-subtitle-removed">0</span> subtitle
                </div>
            </div>
            <div class="stats-card stats-card-transcode">
                <div class="stats-card-title">Videos Transcoded</div>
                <div class="stats-card-value" id="stats-videos-transcoded">0</div>
                <div class="stats-card-detail">
                    <span id="stats-videos-skipped">0</span> skipped
                </div>
            </div>
            <div class="stats-card stats-card-encoder">
                <div class="stats-card-title">Encoding Method</div>
                <div class="stats-card-value stats-card-value-small">
                    <span id="stats-hardware-encodes">0</span> HW /
                    <span id="stats-software-encodes">0</span> SW
                </div>
                <div class="stats-card-detail">hardware / software</div>
            </div>
        </div>

        <!-- Library overview charts -->
        <div id="stats-library-section" class="stats-section stats-charts">
            <h3 class="stats-section-title">Library Overview</h3>
            <div class="stats-charts-grid">
                <div class="stats-chart-container">
                    <h4 class="stats-chart-title">File Count Over Time</h4>
                    <div id="stats-chart-library-files" class="stats-chart" aria-label="Library file count chart"></div>
                </div>
                <div class="stats-chart-container">
                    <h4 class="stats-chart-title">Library Size Over Time</h4>
                    <div id="stats-chart-library-size" class="stats-chart" aria-label="Library size chart"></div>
                </div>
            </div>
        </div>

        <!-- Library Composition pie charts -->
        <div id="stats-composition-section" class="stats-section stats-charts">
            <h3 class="stats-section-title">Library Composition</h3>
            <div class="stats-charts-grid stats-charts-grid--3col">
                <div class="stats-chart-container">
                    <h4 class="stats-chart-title">Container Types</h4>
                    <div id="stats-chart-containers" class="stats-chart stats-chart--pie" aria-label="Container type distribution chart"></div>
                </div>
                <div class="stats-chart-container">
                    <h4 class="stats-chart-title">Video Codecs</h4>
                    <div id="stats-chart-video-codecs" class="stats-chart stats-chart--pie" aria-label="Video codec distribution chart"></div>
                </div>
                <div class="stats-chart-container">
                    <h4 class="stats-chart-title">Audio Codecs</h4>
                    <div id="stats-chart-audio-codecs" class="stats-chart stats-chart--pie" aria-label="Audio codec distribution chart"></div>
                </div>
            </div>
        </div>

        <!-- Charts section -->
        <div id="stats-charts-section" class="stats-section stats-charts" aria-live="polite">
            <h3 class="stats-section-title">Processing Trends</h3>
            <div class="stats-charts-grid">
                <!-- Processing trend chart (files over time) -->
                <div class="stats-chart-container">
                    <h4 class="stats-chart-title">Files Processed Over Time</h4>
                    <div id="stats-chart-trend" class="stats-chart" aria-label="Processing trend line chart"></div>
                </div>

                <!-- Size savings by policy chart -->
                <div class="stats-chart-container">
                    <h4 class="stats-chart-title">Space Savings by Policy</h4>
                    <div id="stats-chart-policy" class="stats-chart" aria-label="Policy savings bar chart"></div>
                </div>

                <!-- Compression gauge -->
                <div class="stats-chart-container stats-chart-gauge-container">
                    <h4 class="stats-chart-title">Average Savings</h4>
                    <div id="stats-chart-gauge" class="stats-chart-gauge" aria-label="Compression ratio gauge"></div>
                </div>
            </div>
        </div>

        <!-- Empty state for no data -->
        <div id="stats-empty" class="stats-empty initially-hidden" role="status" aria-live="polite">
            <div class="stats-empty-icon" aria-hidden="true">&#128200;</div>
            <div class="stats-empty-title">No processing statistics</div>
            <div class="stats-empty-hint">
                Statistics are captured during <code>vpo policy run</code> (non-dry-run).<br>
                Process some files to see statistics here.
            </div>
        </div>

        <!-- Recent processing table -->
        <div id="stats-recent-section" class="stats-section" aria-live="polite">
            <h3 class="stats-section-title">Recent Processing</h3>
            <p class="stats-section-hint">Click a row to view detailed track changes</p>
            <div class="stats-table-container">
                <table class="stats-table stats-table-clickable" id="stats-recent-table" aria-label="Recent processing history">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Policy</th>
                            <th>Space Saved</th>
                            <th>Audio</th>
                            <th>Subtitles</th>
                            <th>Duration</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="stats-recent-body">
                        <!-- Rows populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Stats detail modal -->
        <dialog id="stats-detail-modal" class="stats-modal-dialog" aria-labelledby="stats-detail-title">
            <div class="stats-modal-content">
                <div class="stats-modal-header">
                    <h3 id="stats-detail-title" class="stats-modal-title">Processing Details</h3>
                    <button type="button" class="stats-modal-close" id="stats-detail-close" aria-label="Close">&times;</button>
                </div>
                <div class="stats-modal-body" id="stats-detail-body">
                    <!-- Detail content populated by JavaScript -->
                    <div class="stats-detail-loading">Loading details...</div>
                </div>
            </div>
        </dialog>

        <!-- Policy comparison table -->
        <div id="stats-policies-section" class="stats-section" aria-live="polite">
            <h3 class="stats-section-title">Policy Comparison</h3>
            <div class="stats-table-container">
                <table class="stats-table" id="stats-policies-table" aria-label="Policy statistics comparison">
                    <thead>
                        <tr>
                            <th>Policy</th>
                            <th>Files</th>
                            <th>Success</th>
                            <th>Space Saved</th>
                            <th>Avg Savings</th>
                            <th>Last Used</th>
                        </tr>
                    </thead>
                    <tbody id="stats-policies-body">
                        <!-- Rows populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="/static/js/charts.js"></script>
<script src="/static/js/stats.js"></script>
{% endblock %}
