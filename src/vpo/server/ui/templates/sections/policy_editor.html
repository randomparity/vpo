{% extends "base.html" %}

{% block content %}
<div class="policy-editor">
    <!-- Back navigation -->
    <a href="/policies" class="policy-editor-back"><span aria-hidden="true">&larr;</span> Back to Policies</a>

    <!-- Policy header -->
    <header class="policy-editor-header">
        <h1 class="policy-editor-title">{{ policy.name }}</h1>
        {% if policy.parse_error %}
        <span class="status-badge status-badge--failed">parse error</span>
        {% endif %}
        <span class="policy-version-badge">Schema v{{ policy.schema_version }}</span>
    </header>

    {% if policy.parse_error %}
    <!-- Parse error message -->
    <section class="policy-editor-error">
        <h2>Parse Error</h2>
        <div class="policy-editor-error-message">{{ policy.parse_error }}</div>
        <p>Please fix the YAML syntax errors before editing.</p>
    </section>
    {% else %}
    <!-- Unknown fields warning banner (T076) -->
    <div id="unknown-fields-warning" class="unknown-fields-warning initially-hidden">
        <strong>Note:</strong> This policy contains fields not shown in the editor.
        These fields will be preserved when saving.
    </div>

    <!-- Editor container with form and preview -->
    <div class="policy-editor-container">

    <!-- Editor form -->
    <form id="policy-editor-form" class="policy-editor-form">
        <!-- Validation errors (at top for visibility) -->
        <div id="validation-errors" class="validation-errors" role="alert" aria-live="assertive"></div>

        <!-- Policy Metadata Section -->
        <section class="editor-section">
            <h2>Policy Metadata</h2>
            <p class="section-description">Optional display name shown in the UI instead of the filename.</p>

            <div class="form-group">
                <label for="policy-display-name">Display Name</label>
                <input
                    type="text"
                    id="policy-display-name"
                    value="{{ (policy.display_name or '')|e }}"
                    placeholder="e.g., My Anime Policy"
                />
            </div>
        </section>

        <!-- Track Ordering Section (US1) -->
        <section class="editor-section">
            <h2>Track Ordering</h2>
            <p class="section-description">Define the order in which track types appear in processed files.</p>

            <div class="track-order-container">
                <ul id="track-order-list" class="track-order-list" role="list" aria-label="Track ordering">
                    <!-- Populated by JavaScript -->
                </ul>
            </div>
        </section>

        <!-- Audio Language Preferences Section (US2) -->
        <section class="editor-section">
            <h2>Audio Language Preferences</h2>
            <p class="section-description">Preferred audio languages in priority order (ISO 639-2 codes).</p>

            <div class="language-input-group">
                <label for="audio-lang-input">Add Language</label>
                <input
                    type="text"
                    id="audio-lang-input"
                    placeholder="e.g., eng, jpn, fra"
                    aria-describedby="audio-lang-input-error"
                    maxlength="3"
                />
                <button type="button" id="audio-lang-add-btn" class="btn-secondary">Add</button>
                <span id="audio-lang-input-error" class="input-error-hint"></span>
            </div>

            <ul id="audio-lang-list" class="language-list" role="list" aria-label="Audio language preferences">
                <!-- Populated by JavaScript -->
            </ul>
        </section>

        <!-- Subtitle Language Preferences Section -->
        <section class="editor-section">
            <h2>Subtitle Language Preferences</h2>
            <p class="section-description">Preferred subtitle languages in priority order (ISO 639-2 codes).</p>

            <div class="language-input-group">
                <label for="subtitle-lang-input">Add Language</label>
                <input
                    type="text"
                    id="subtitle-lang-input"
                    placeholder="e.g., eng, jpn, fra"
                    aria-describedby="subtitle-lang-input-error"
                    maxlength="3"
                />
                <button type="button" id="subtitle-lang-add-btn" class="btn-secondary">Add</button>
                <span id="subtitle-lang-input-error" class="input-error-hint"></span>
            </div>

            <ul id="subtitle-lang-list" class="language-list" role="list" aria-label="Subtitle language preferences">
                <!-- Populated by JavaScript -->
            </ul>
        </section>

        <!-- Default Flags Section -->
        <section class="editor-section">
            <h2>Default Flags</h2>
            <p class="section-description">Configure which tracks are marked as default.</p>

            <div class="checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="set_first_video_default" name="set_first_video_default">
                    <span>Set first video track as default</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="set_preferred_audio_default" name="set_preferred_audio_default">
                    <span>Set preferred audio track as default</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="set_preferred_subtitle_default" name="set_preferred_subtitle_default">
                    <span>Set preferred subtitle track as default</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="clear_other_defaults" name="clear_other_defaults">
                    <span>Clear other default flags</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="set_subtitle_default_when_audio_differs" name="set_subtitle_default_when_audio_differs">
                    <span>Set subtitle default when audio language differs from preference</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="set_subtitle_forced_when_audio_differs" name="set_subtitle_forced_when_audio_differs">
                    <span>Set subtitle forced when audio language differs from preference</span>
                </label>
            </div>

            <div class="form-group mt-md">
                <label for="preferred_audio_codec">Preferred Audio Codec</label>
                <p id="preferred-audio-codec-description" class="section-description">Comma-separated list of preferred audio codecs when selecting the default audio track (e.g., eac3, ac3). Language preference always takes priority.</p>
                <input
                    type="text"
                    id="preferred_audio_codec"
                    name="preferred_audio_codec"
                    placeholder="e.g., eac3, ac3"
                    aria-describedby="preferred-audio-codec-description"
                />
            </div>
        </section>

        <!-- Commentary Detection Section (US4) -->
        <section class="editor-section">
            <h2>Commentary Detection</h2>
            <p class="section-description">Configure patterns and settings for detecting commentary tracks.</p>

            <div class="commentary-patterns-group">
                <label for="commentary-pattern-input">Commentary Patterns (regex)</label>
                <div class="pattern-input-group">
                    <input
                        type="text"
                        id="commentary-pattern-input"
                        placeholder="e.g., commentary, director, ^Commentary$"
                        aria-describedby="commentary-pattern-input-error"
                    />
                    <button type="button" id="commentary-pattern-add-btn" class="btn-secondary">Add Pattern</button>
                    <span id="commentary-pattern-input-error" class="input-error-hint"></span>
                </div>

                <ul id="commentary-patterns-list" class="patterns-list" role="list" aria-label="Commentary patterns">
                    <!-- Populated by JavaScript -->
                </ul>
            </div>

            <div class="transcription-settings">
                <h3>Transcription Settings</h3>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="detect_commentary" name="detect_commentary">
                        <span>Enable commentary detection</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="reorder_commentary" name="reorder_commentary">
                        <span>Move commentary tracks to end (requires detection enabled)</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="update_language_from_transcription" name="update_language_from_transcription">
                        <span>Update track language tags from transcription results</span>
                    </label>
                </div>
                <div class="form-group mt-sm">
                    <label for="confidence_threshold">Confidence Threshold (%)</label>
                    <input type="number" id="confidence_threshold" name="confidence_threshold"
                           min="0" max="100" step="1" placeholder="80">
                    <p class="form-hint">Minimum confidence for language updates (default 80%).</p>
                </div>
            </div>
        </section>

        <!-- V3-V10 Advanced Settings (Accordion Sections) -->
        <div id="advanced-settings" class="advanced-settings-container">

            <!-- V6 Video Transcode Section (US1 - MVP) -->
            <details id="section-transcode" class="accordion-section" open>
                <summary class="accordion-header">
                    <h3 class="accordion-title">Video & Audio Transcoding</h3>
                    <span class="accordion-icon">▼</span>
                </summary>
                <div class="accordion-content">
                    <p class="accordion-description">Configure video and audio transcoding settings (V6+ features).</p>

                    <!-- Video Transcode Subsection -->
                    <div id="video-transcode-section">
                        <h4 class="accordion-subsection-title">Video Transcode</h4>
                        <!-- Populated by section-transcode.js -->
                        <div class="form-group">
                            <label for="video-target-codec">Target Codec</label>
                            <select id="video-target-codec">
                                <option value="">-- Not configured --</option>
                                <option value="hevc">HEVC (H.265)</option>
                                <option value="h264">H.264 (AVC)</option>
                                <option value="vp9">VP9</option>
                                <option value="av1">AV1</option>
                            </select>
                        </div>
                        <div id="video-transcode-options" class="initially-hidden">
                            <!-- Dynamic options populated by JS -->
                        </div>
                    </div>

                    <!-- Audio Transcode Subsection -->
                    <div id="audio-transcode-section" class="accordion-subsection">
                        <h4 class="accordion-subsection-title">Audio Transcode</h4>
                        <!-- Populated by section-transcode.js -->
                        <div class="form-group">
                            <label for="audio-transcode-to">Transcode Non-Preserved Audio To</label>
                            <select id="audio-transcode-to">
                                <option value="">-- Not configured --</option>
                                <option value="aac">AAC</option>
                                <option value="ac3">AC3 (Dolby Digital)</option>
                                <option value="eac3">E-AC3 (Dolby Digital Plus)</option>
                                <option value="opus">Opus</option>
                                <option value="flac">FLAC</option>
                            </select>
                        </div>
                        <div id="audio-transcode-options" class="initially-hidden">
                            <!-- Dynamic options populated by JS -->
                        </div>
                    </div>
                </div>
            </details>

            <!-- V3 Track Filters Section (US5) -->
            <details id="section-filters" class="accordion-section">
                <summary class="accordion-header">
                    <h3 class="accordion-title">Track Filtering</h3>
                    <span class="accordion-icon">▼</span>
                </summary>
                <div class="accordion-content">
                    <p class="accordion-description">Configure audio, subtitle, and attachment filtering (V3+ features).</p>
                    <!-- Populated by section-filters.js -->
                    <div id="audio-filter-section">
                        <h4 class="accordion-subsection-title">Audio Filter</h4>
                        <p class="form-hint">Filter audio tracks by language.</p>
                    </div>
                    <div id="subtitle-filter-section" class="accordion-subsection">
                        <h4 class="accordion-subsection-title">Subtitle Filter</h4>
                        <p class="form-hint">Filter subtitle tracks by language.</p>
                    </div>
                    <div id="attachment-filter-section" class="accordion-subsection">
                        <h4 class="accordion-subsection-title">Attachment Filter</h4>
                        <p class="form-hint">Configure attachment handling.</p>
                    </div>
                </div>
            </details>

            <!-- V4 Conditional Rules Section (US4) -->
            <details id="section-conditional" class="accordion-section">
                <summary class="accordion-header">
                    <h3 class="accordion-title">Conditional Rules</h3>
                    <span class="accordion-icon">▼</span>
                </summary>
                <div class="accordion-content">
                    <p class="accordion-description">Define conditional rules with when/then/else logic (V4+ features).</p>
                    <!-- Populated by section-conditional.js -->
                    <div id="conditional-rules-list">
                        <p class="accordion-list-empty">No conditional rules configured. Click "Add Rule" to create one.</p>
                    </div>
                    <button type="button" id="add-conditional-rule-btn" class="btn-secondary mt-md">
                        Add Rule
                    </button>
                </div>
            </details>

            <!-- V5 Audio Synthesis Section (US3) -->
            <details id="section-synthesis" class="accordion-section">
                <summary class="accordion-header">
                    <h3 class="accordion-title">Audio Synthesis</h3>
                    <span class="accordion-icon">▼</span>
                </summary>
                <div class="accordion-content">
                    <p class="accordion-description">Create synthesized audio tracks from existing sources (V5+ features).</p>
                    <!-- Populated by section-synthesis.js -->
                    <div id="synthesis-tracks-list">
                        <p class="accordion-list-empty">No synthesis tracks configured. Click "Add Track" to create one.</p>
                    </div>
                    <button type="button" id="add-synthesis-track-btn" class="btn-secondary mt-md">
                        Add Track
                    </button>
                </div>
            </details>

            <!-- V3 Container Section (US6) -->
            <details id="section-container" class="accordion-section">
                <summary class="accordion-header">
                    <h3 class="accordion-title">Container Format</h3>
                    <span class="accordion-icon">▼</span>
                </summary>
                <div class="accordion-content">
                    <p class="accordion-description">Configure container format conversion (V3+ features).</p>
                    <!-- Populated by section-container.js -->
                    <div class="form-group">
                        <label for="container-target">Target Container</label>
                        <select id="container-target">
                            <option value="">-- No conversion --</option>
                            <option value="mkv">MKV (Matroska)</option>
                            <option value="mp4">MP4</option>
                        </select>
                    </div>
                    <div id="container-options" class="initially-hidden">
                        <div class="form-group">
                            <label for="container-on-incompatible">On Incompatible Codec</label>
                            <select id="container-on-incompatible">
                                <option value="error">Error (stop processing)</option>
                                <option value="skip">Skip (keep original)</option>
                                <option value="transcode">Transcode (convert codec)</option>
                            </select>
                            <p class="form-hint">Action when a track's codec isn't compatible with the target container.</p>
                        </div>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="container-preserve-metadata" checked>
                                <span>Preserve source metadata during container conversion</span>
                            </label>
                            <p class="form-hint">Copy metadata tags from source file. Disable to start with clean metadata.</p>
                        </div>
                    </div>
                </div>
            </details>

            <!-- V11 User-Defined Phases Section (037-user-defined-phases) -->
            <details id="section-phases" class="accordion-section" {% if policy.schema_version == 11 %}open{% endif %}>
                <summary class="accordion-header">
                    <h3 class="accordion-title">User-Defined Phases</h3>
                    <span class="accordion-icon">▼</span>
                </summary>
                <div class="accordion-content" id="phases-section-container">
                    <p class="accordion-description">Define custom processing phases with specific operations (V11 feature).</p>

                    <!-- Global config for V11 -->
                    <div class="form-group mb-lg">
                        <label for="config-on-error">On Error</label>
                        <select id="config-on-error">
                            <option value="skip">Skip (continue to next file)</option>
                            <option value="continue">Continue (proceed with next phase)</option>
                            <option value="fail">Fail (stop batch)</option>
                        </select>
                        <p class="form-hint">Action when an error occurs during phase execution.</p>
                    </div>

                    <!-- Phases list -->
                    <div id="phases-list">
                        <p class="accordion-list-empty">No phases configured. Click "Add Phase" to create one.</p>
                    </div>
                    <button type="button" id="add-phase-btn" class="btn-secondary mt-md">
                        Add Phase
                    </button>
                </div>
            </details>

            <!-- V9 Workflow Section (US7) - for V1-V10 policies -->
            <details id="section-workflow" class="accordion-section{% if policy.schema_version == 11 %} initially-hidden{% endif %}">
                <summary class="accordion-header">
                    <h3 class="accordion-title">Workflow Configuration</h3>
                    <span class="accordion-icon">▼</span>
                </summary>
                <div class="accordion-content">
                    <p class="accordion-description">Configure workflow phases and error handling (V9+ features).</p>
                    <!-- Populated by section-workflow.js -->
                    <div class="form-group">
                        <label>Processing Phases</label>
                        <div class="checkbox-group" id="workflow-phases">
                            <label class="checkbox-label">
                                <input type="checkbox" id="phase-analyze" name="phases" value="analyze" checked>
                                <span>Analyze</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="phase-apply" name="phases" value="apply" checked>
                                <span>Apply</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="phase-transcode" name="phases" value="transcode">
                                <span>Transcode</span>
                            </label>
                        </div>
                        <p class="form-hint">Select which phases to include in the workflow.</p>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="workflow-auto-process">Auto Process</label>
                            <select id="workflow-auto-process">
                                <option value="false">Disabled</option>
                                <option value="true">Enabled</option>
                            </select>
                            <p class="form-hint">Automatically process files when scanned.</p>
                        </div>
                        <div class="form-group">
                            <label for="workflow-on-error">On Error</label>
                            <select id="workflow-on-error">
                                <option value="continue">Continue</option>
                                <option value="skip">Skip File</option>
                                <option value="fail">Fail Job</option>
                            </select>
                            <p class="form-hint">Action when an error occurs during processing.</p>
                        </div>
                    </div>
                </div>
            </details>

        </div><!-- End advanced-settings -->

        <!-- Form actions -->
        <div class="editor-actions">
            <button type="button" id="save-btn" class="btn-primary">Save Changes</button>
            <button type="button" id="test-policy-btn" class="btn-outline-primary" title="Validate without saving">Test Policy</button>
            <button type="button" id="cancel-btn" class="btn-secondary">Cancel</button>
            <span id="save-status" class="save-status" role="status" aria-live="polite"></span>
        </div>
    </form>

    <!-- YAML Preview Panel (US5) with syntax highlighting (T051) -->
    <aside class="yaml-preview-panel">
        <h2>YAML Preview</h2>
        <p class="section-description">Real-time preview of the policy file</p>
        <pre class="yaml-preview-container" tabindex="0" aria-label="YAML policy preview" aria-readonly="true"><code id="yaml-preview" class="language-yaml"></code></pre>
    </aside>

    </div><!-- End policy-editor-container -->
    {% endif %}

    <!-- Undo toast for destructive actions (H3) -->
    <div id="undo-toast" class="undo-toast" hidden role="alert" aria-live="assertive">
        <span class="toast-message"></span>
        <button type="button" class="toast-undo-btn">Undo</button>
        <button type="button" class="toast-close-btn" aria-label="Dismiss">&times;</button>
    </div>

    <!-- Screen reader status region for save announcements (H5) -->
    <span id="sr-save-status" class="sr-only" aria-live="polite"></span>
</div>

<!-- Pass policy data and CSRF token to JavaScript (no inline script for CSP) -->
<meta name="csrf-token" content="{{ csrf_token }}">
<script type="application/json" id="policy-data">{{ policy.to_dict() | tojson }}</script>
<link rel="stylesheet" href="/static/css/components/confirmation-modal.css">
<script src="/static/js/components/confirmation-modal.js"></script>
<!-- CDN libraries for policy editor (256-policy-editor-enhancements) -->
<!-- SRI hashes below are integrity checksums, not secrets -->
<script src="https://cdn.jsdelivr.net/npm/ajv@8.17.1/dist/ajv7.bundle.min.js"
        integrity="sha384-2lXfKVfMgXEf8v5HvM8X/6TE1IOQdCKmPfxRwXzJ2VcqNhVQ9jkVBNj8QKQmZk2p" crossorigin="anonymous" async></script><!-- pragma: allowlist secret -->
<!-- Highlight.js for YAML syntax highlighting (T051) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/github-dark.min.css"
      integrity="sha384-hXSfn69mEJdPJNKS8aHzW6xDCYzw+PbLpLkCJXvxEeV8FfVcVbTy3QRLDdR/PV1N" crossorigin="anonymous"><!-- pragma: allowlist secret -->
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"
        integrity="sha384-xBsHBR6CP1UT3NrCcJkIq6gwKRCflZEbch5HsGhFC6zD9epLJvNJr4vASNNHcGKU" crossorigin="anonymous" async></script><!-- pragma: allowlist secret -->
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/yaml.min.js"
        integrity="sha384-hT5gXe+p5rGkJUbPlLxiMeS/6C5D0bKpNtAbxGAO1MBuOjN8u9FRfKMq7FN2zk9L" crossorigin="anonymous" async></script><!-- pragma: allowlist secret -->
<script type="module" src="/static/js/policy-editor/policy-editor.js"></script>
{% endblock %}
